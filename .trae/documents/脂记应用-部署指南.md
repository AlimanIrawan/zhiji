# 脂记应用 - 完整部署指南

## 📋 项目概述

脂记是一个基于 Next.js 14 的智能饮食追踪应用，集成了 AI 食物分析和 Garmin 运动数据同步功能。

### 技术栈
- **前端**: Next.js 14 + TypeScript + Tailwind CSS
- **认证**: NextAuth.js
- **数据存储**: Vercel KV (Redis)
- **文件存储**: Vercel Blob
- **AI 服务**: OpenAI GPT-4 Vision API
- **运动数据**: Garmin Connect API

## 🚀 部署方案（推荐：Vercel）

### 1. 准备工作

#### 1.1 代码准备
```bash
# 确保项目构建成功
cd zhiji-app
npm install
npm run build
npm run type-check
```

#### 1.2 Git 仓库
```bash
# 初始化 Git 仓库（如果还没有）
git init
git add .
git commit -m "Initial commit"

# 推送到 GitHub/GitLab
git remote add origin <your-repo-url>
git push -u origin main
```

### 2. Vercel 部署步骤

#### 2.1 连接 Vercel
1. 访问 [vercel.com](https://vercel.com)
2. 使用 GitHub/GitLab 账户登录
3. 点击 "New Project"
4. 选择你的 `zhiji-app` 仓库
5. 配置项目设置：
   - **Framework Preset**: Next.js
   - **Root Directory**: `./` (如果项目在根目录)
   - **Build Command**: `npm run build`
   - **Output Directory**: `.next`

#### 2.2 环境变量配置
在 Vercel 项目设置中添加以下环境变量：

```env
# NextAuth 配置
NEXTAUTH_URL=https://your-domain.vercel.app
NEXTAUTH_SECRET=your-super-secret-key-here

# Vercel KV (Redis) - 自动配置
KV_REST_API_URL=<vercel-kv-url>
KV_REST_API_TOKEN=<vercel-kv-token>

# OpenAI API
OPENAI_API_KEY=sk-your-openai-api-key

# Garmin Connect (可选)
GARMIN_USERNAME=your-garmin-username
GARMIN_PASSWORD=your-garmin-password
```

## 🔧 环境变量详细配置

### 3.1 必需环境变量

| 变量名 | 描述 | 获取方式 |
|--------|------|----------|
| `NEXTAUTH_URL` | 应用的完整 URL | 部署后的域名 |
| `NEXTAUTH_SECRET` | NextAuth 加密密钥 | 生成随机字符串 |
| `OPENAI_API_KEY` | OpenAI API 密钥 | OpenAI 官网申请 |

### 3.2 Vercel KV 配置

1. 在 Vercel 项目中：
   - 进入 "Storage" 标签
   - 点击 "Create Database"
   - 选择 "KV (Redis)"
   - 创建数据库
   - 环境变量会自动添加

### 3.3 生成 NEXTAUTH_SECRET

```bash
# 方法 1: 使用 OpenSSL
openssl rand -base64 32

# 方法 2: 使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# 方法 3: 在线生成
# 访问 https://generate-secret.vercel.app/32
```

## 🌐 域名配置

### 4.1 自定义域名（可选）

1. 在 Vercel 项目设置中：
   - 进入 "Domains" 标签
   - 添加自定义域名
   - 配置 DNS 记录

2. DNS 配置示例：
```
Type: CNAME
Name: www
Value: cname.vercel-dns.com

Type: A
Name: @
Value: 76.76.19.19
```

### 4.2 SSL 证书
- Vercel 自动提供 SSL 证书
- 支持自动续期
- 无需额外配置

## 🗄️ 数据库设置

### 5.1 Vercel KV 设置

Vercel KV 是基于 Redis 的托管数据库服务：

1. **自动配置**: 创建后环境变量自动注入
2. **数据持久化**: 自动备份和恢复
3. **全球分布**: 边缘网络优化
4. **免费额度**: 
   - 30,000 次请求/月
   - 256MB 存储空间

### 5.2 数据结构

应用使用以下 Redis 数据结构：

```typescript
// 用户认证
auth:email:{email} -> 用户信息哈希
auth:session:{sessionId} -> 会话信息

// 用户数据
user:{userId}:profile -> 用户资料
user:{userId}:foods -> 食物记录列表
user:{userId}:garmin -> Garmin 数据

// 食物记录
food:{foodId} -> 食物详细信息

// 每日汇总
daily:{userId}:{date} -> 每日营养汇总
```

## 🔌 第三方服务配置

### 6.1 OpenAI API 配置

1. **获取 API Key**:
   - 访问 [platform.openai.com](https://platform.openai.com)
   - 注册/登录账户
   - 创建 API Key
   - 设置使用限制和预算

2. **模型选择**:
   - 推荐使用 `gpt-4-vision-preview`
   - 支持图像分析功能
   - 成本约 $0.01-0.03/次分析

3. **安全设置**:
   - 设置 API Key 使用限制
   - 监控使用量和成本
   - 定期轮换 API Key

### 6.2 Garmin Connect API

1. **账户准备**:
   - 需要有效的 Garmin Connect 账户
   - 确保有运动数据记录

2. **配置说明**:
   - 使用用户名/密码认证
   - 支持自动数据同步
   - 可选功能，不影响核心功能

## ✅ 部署前检查清单

### 7.1 代码检查
- [ ] 所有 TypeScript 错误已修复
- [ ] 构建成功 (`npm run build`)
- [ ] 类型检查通过 (`npm run type-check`)
- [ ] ESLint 检查通过 (`npm run lint`)

### 7.2 环境变量检查
- [ ] `NEXTAUTH_URL` 设置为正确的域名
- [ ] `NEXTAUTH_SECRET` 已生成并设置
- [ ] `OPENAI_API_KEY` 已配置且有效
- [ ] Vercel KV 数据库已创建

### 7.3 功能测试
- [ ] 用户注册/登录功能正常
- [ ] AI 食物分析功能正常
- [ ] 数据存储和读取正常
- [ ] 响应式设计在移动端正常

## 🚨 常见问题解决方案

### 8.1 部署失败

**问题**: 构建失败
```bash
Error: Type error: Cannot find module '@/lib/storage'
```

**解决方案**:
```bash
# 检查 tsconfig.json 路径配置
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

### 8.2 环境变量问题

**问题**: KV_REST_API_URL 未定义
```
Failed to parse URL from your_kv_rest_api_url
```

**解决方案**:
1. 确保 Vercel KV 数据库已创建
2. 重新部署项目以获取最新环境变量
3. 检查环境变量是否正确注入

### 8.3 NextAuth 配置问题

**问题**: 登录重定向失败
```
[next-auth][error][SIGNIN_EMAIL_ERROR]
```

**解决方案**:
1. 检查 `NEXTAUTH_URL` 是否正确
2. 确保 `NEXTAUTH_SECRET` 已设置
3. 验证域名配置

### 8.4 OpenAI API 问题

**问题**: API 调用失败
```
Error: OpenAI API key not configured
```

**解决方案**:
1. 验证 API Key 格式 (sk-...)
2. 检查 API Key 权限和余额
3. 确认模型可用性

## 📊 监控和维护

### 9.1 Vercel Analytics

启用 Vercel Analytics 监控：
1. 在项目设置中启用 Analytics
2. 监控页面性能和用户行为
3. 查看错误日志和崩溃报告

### 9.2 成本监控

**Vercel 免费额度**:
- 100GB 带宽/月
- 100 次部署/天
- 无限静态网站

**付费功能**:
- Vercel KV: $0.25/100K 请求
- Vercel Blob: $0.15/GB 存储
- 函数执行时间超限

### 9.3 性能优化

1. **图片优化**:
   - 使用 Next.js Image 组件
   - 启用 WebP 格式
   - 配置适当的缓存策略

2. **代码分割**:
   - 使用动态导入
   - 优化包大小
   - 启用 Tree Shaking

3. **缓存策略**:
   - 配置 Redis 缓存
   - 使用 SWR 进行数据获取
   - 启用 CDN 缓存

### 9.4 安全维护

1. **定期更新**:
   - 更新依赖包版本
   - 修复安全漏洞
   - 轮换 API Keys

2. **访问控制**:
   - 实施速率限制
   - 添加 CORS 配置
   - 监控异常访问

## 🔄 更新和回滚

### 10.1 自动部署

Vercel 支持 Git 集成自动部署：
- 推送到 `main` 分支自动部署到生产环境
- 推送到其他分支创建预览部署
- 支持部署钩子和通知

### 10.2 回滚策略

```bash
# 通过 Vercel CLI 回滚
vercel --prod --rollback

# 或在 Vercel Dashboard 中选择历史部署进行回滚
```

## 📞 技术支持

如遇到部署问题，可以：

1. **查看日志**: Vercel Dashboard > Functions 标签
2. **社区支持**: Vercel Discord 社区
3. **文档参考**: [vercel.com/docs](https://vercel.com/docs)
4. **GitHub Issues**: 项目仓库提交问题

---

## 🎉 部署完成

恭喜！您的脂记应用已成功部署到生产环境。

**下一步**:
1. 测试所有功能是否正常
2. 配置监控和告警
3. 准备用户文档和使用指南
4. 考虑 SEO 优化和性能调优

**访问地址**: https://your-domain.vercel.app

祝您使用愉快！🎊