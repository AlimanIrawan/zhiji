====================================
      重要更新说明
====================================

本次更新日期: 2025-10-19

------------------------------------
【核心变更】
------------------------------------

✅ 移除了所有降级方案
   - 不再提供关键词匹配的降级分析
   - 必须使用真实的OpenAI API进行食物分析
   - 确保数据质量和分析准确性

------------------------------------
【影响说明】
------------------------------------

1. OpenAI API Key 现在是必填项
   
   之前: API Key可选,不配置会使用关键词匹配
   现在: 必须配置,否则无法使用食物分析功能
   
   配置方法:
   - 编辑 backend/.env 文件
   - 填写真实的 OPENAI_API_KEY
   - API Key格式: sk-proj-xxxxxx 或 sk-xxxxxx

2. 错误提示更加明确
   
   如果未配置或调用失败,会显示清晰的错误信息:
   - "未配置OpenAI API Key,请在环境变量中设置"
   - "AI分析失败: [具体错误原因]"
   - "AI返回的热量值异常: xxx"

3. 使用最新的GPT-4o模型
   
   之前: gpt-4-vision-preview
   现在: gpt-4o (更快、更准确、更便宜)

4. 更严格的数据验证
   
   - 检查所有必需字段是否存在
   - 验证数值合理性 (0 < 热量 < 5000)
   - 数值格式标准化 (热量为整数,其他保留1位小数)

------------------------------------
【优化内容】
------------------------------------

✅ 更精确的Prompt
   - 要求AI观察份量、烹饪方式
   - 考虑油炸等烹饪方式对热量的影响
   - 建议要具体可操作

✅ 更好的JSON解析
   - 优先尝试直接解析JSON
   - 失败时尝试从文本中提取
   - 提取失败时抛出明确错误

✅ 完善的错误处理
   - 前端捕获并显示用户友好的错误信息
   - 后端记录详细的错误日志
   - 不静默失败,确保用户知道问题所在

------------------------------------
【使用指南】
------------------------------------

1. 首次使用前准备

   a. 获取OpenAI API Key:
      - 访问 https://platform.openai.com/api-keys
      - 创建新的API Key
      - 确保有GPT-4o模型访问权限
      - 账户需要有余额 ($5起充)

   b. 配置环境变量:
      cd "/Users/LW/Documents/AIPLUS/2510 脂记"
      cp backend/env.template backend/.env
      nano backend/.env
      
      # 修改这一行:
      OPENAI_API_KEY=sk-proj-你的真实API密钥

   c. 重新安装依赖:
      source backend/venv/bin/activate
      pip install --upgrade -r backend/requirements.txt

   d. 启动应用:
      ./start_local.sh

2. 测试AI分析功能

   a. 打开应用: http://localhost:8000
   
   b. 进入"饮食记录"页面
   
   c. 输入食物描述,例如:
      "午餐: 炸鸡排一份(约150g)、白米饭一碗、清炒西兰花"
   
   d. 点击"分析营养成分"
   
   e. 等待AI分析(约3-5秒)
   
   f. 查看结果是否准确

3. 查看API使用情况

   - 访问 https://platform.openai.com/usage
   - 查看API调用次数和费用
   - 每次分析约消耗 $0.01-0.03

------------------------------------
【成本估算】
------------------------------------

使用GPT-4o模型:
- 输入: $5 / 1M tokens
- 输出: $15 / 1M tokens

单次分析预估:
- 图片 + 描述: 约1000 tokens输入 + 100 tokens输出
- 成本: $0.005 + $0.0015 = $0.0065/次
- 约 ¥0.05/次 (按汇率7.2计算)

月度使用 (每天3次记录):
- 3次/天 × 30天 = 90次/月
- 成本: 90 × $0.0065 = $0.585/月
- 约 ¥4.2/月

------------------------------------
【注意事项】
------------------------------------

⚠️ 如果遇到以下错误:

1. "未配置OpenAI API Key"
   → 检查 backend/.env 文件是否正确配置

2. "API Key无效"
   → 检查API Key是否正确,是否过期

3. "余额不足"
   → 前往 https://platform.openai.com/account/billing 充值

4. "模型访问受限"
   → 检查是否有GPT-4o访问权限
   → 新账号可能需要充值$5才能使用GPT-4

5. "热量值异常"
   → AI返回的数据不合理
   → 可能是描述不够清晰,建议重新描述或上传图片

------------------------------------
【回滚方法】
------------------------------------

如果需要回到有降级方案的版本:

git log --oneline  # 查看提交历史
git checkout <之前的commit-id>  # 回到之前的版本

------------------------------------
【技术细节】
------------------------------------

修改的文件:
1. backend/services/openai_service.py
   - 移除 _fallback_analysis() 方法
   - 更新 analyze_food() 方法,失败时抛出异常
   - 增强 _validate_result() 验证逻辑
   - 更新为 gpt-4o 模型

2. frontend/api-integration.js
   - 移除降级到原始函数的逻辑
   - 增强错误提示
   - 显示用户友好的错误信息

3. backend/requirements.txt
   - 更新 openai==1.54.3

4. backend/env.template
   - 添加必填说明
   - 添加获取地址

5. README.txt & DEPLOYMENT.txt
   - 更新说明文档
   - 强调必填项
   - 移除降级方案相关内容

------------------------------------
【联系支持】
------------------------------------

如有问题,请检查:
1. 后端日志: 查看终端输出
2. 前端日志: 打开浏览器控制台(F12)
3. 健康检查: 访问 http://localhost:5000/health

祝使用愉快！💪

