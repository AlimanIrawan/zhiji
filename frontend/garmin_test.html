<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garmin Connect æ•°æ®æµ‹è¯•</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- APIé…ç½® -->
    <script src="config.js"></script>
    <script src="api.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fa fa-heartbeat text-red-500 mr-2"></i>
                    Garmin Connect æ•°æ®æµ‹è¯•
                </h1>
                <button id="test-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fa fa-play mr-2"></i>
                    å¼€å§‹æµ‹è¯•
                </button>
            </div>
            <p class="text-gray-600 mt-2">æµ‹è¯•Garmin Connectè¿æ¥å¹¶æŸ¥çœ‹å¯ç”¨çš„æ•°æ®ç±»å‹</p>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div id="status-card" class="bg-white rounded-xl shadow-md p-6 mb-6 hidden">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">è¿æ¥çŠ¶æ€</h2>
            <div id="status-content" class="space-y-3">
                <!-- çŠ¶æ€å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div id="results-card" class="bg-white rounded-xl shadow-md p-6 mb-6 hidden">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">æµ‹è¯•ç»“æœ</h2>
            <div id="results-content" class="space-y-4">
                <!-- æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åŸå§‹æ•°æ® -->
        <div id="raw-data-card" class="bg-white rounded-xl shadow-md p-6 hidden">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">åŸå§‹æ•°æ®</h2>
            <div class="bg-gray-100 rounded-lg p-4">
                <pre id="raw-data" class="text-sm text-gray-700 whitespace-pre-wrap overflow-auto max-h-96"></pre>
            </div>
        </div>

        <!-- è¿”å›æŒ‰é’® -->
        <div class="text-center">
            <a href="index.html" class="inline-flex items-center text-blue-500 hover:text-blue-600 transition-colors">
                <i class="fa fa-arrow-left mr-2"></i>
                è¿”å›ä¸»åº”ç”¨
            </a>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–APIå®¢æˆ·ç«¯
        const apiClient = new APIClient();
        
        // æµ‹è¯•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('test-btn').addEventListener('click', async function() {
            await runGarminTest();
        });

        async function runGarminTest() {
            const testBtn = document.getElementById('test-btn');
            const statusCard = document.getElementById('status-card');
            const resultsCard = document.getElementById('results-card');
            const rawDataCard = document.getElementById('raw-data-card');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            testBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
            
            try {
                console.log('ğŸ” å¼€å§‹Garminè¿æ¥æµ‹è¯•...');
                
                // è°ƒç”¨æµ‹è¯•API
                const response = await fetch(`${apiClient.baseURL}/api/garmin/test`);
                const data = await response.json();
                
                console.log('ğŸ” Garminæµ‹è¯•ç»“æœ:', data);
                
                // æ˜¾ç¤ºçŠ¶æ€
                displayStatus(data);
                statusCard.classList.remove('hidden');
                
                if (data.success) {
                    // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
                    displayResults(data.test_data);
                    resultsCard.classList.remove('hidden');
                    
                    // æ˜¾ç¤ºåŸå§‹æ•°æ®
                    displayRawData(data);
                    rawDataCard.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('âŒ Garminæµ‹è¯•å¤±è´¥:', error);
                displayError(error);
                statusCard.classList.remove('hidden');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                testBtn.innerHTML = '<i class="fa fa-play mr-2"></i>å¼€å§‹æµ‹è¯•';
                testBtn.disabled = false;
            }
        }

        function displayStatus(data) {
            const statusContent = document.getElementById('status-content');
            
            let statusHtml = '';
            
            // é…ç½®çŠ¶æ€
            statusHtml += `
                <div class="flex items-center justify-between p-3 rounded-lg ${data.configured ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                    <div class="flex items-center">
                        <i class="fa fa-cog mr-2 ${data.configured ? 'text-green-500' : 'text-red-500'}"></i>
                        <span class="font-medium">è´¦å·é…ç½®</span>
                    </div>
                    <span class="px-2 py-1 rounded text-sm ${data.configured ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${data.configured ? 'å·²é…ç½®' : 'æœªé…ç½®'}
                    </span>
                </div>
            `;
            
            // ç™»å½•çŠ¶æ€
            if (data.configured) {
                statusHtml += `
                    <div class="flex items-center justify-between p-3 rounded-lg ${data.login_success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                        <div class="flex items-center">
                            <i class="fa fa-sign-in mr-2 ${data.login_success ? 'text-green-500' : 'text-red-500'}"></i>
                            <span class="font-medium">ç™»å½•çŠ¶æ€</span>
                        </div>
                        <span class="px-2 py-1 rounded text-sm ${data.login_success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${data.login_success ? 'æˆåŠŸ' : 'å¤±è´¥'}
                        </span>
                    </div>
                `;
            }
            
            // é”™è¯¯ä¿¡æ¯
            if (data.error) {
                statusHtml += `
                    <div class="p-3 rounded-lg bg-red-50 border border-red-200">
                        <div class="flex items-center mb-2">
                            <i class="fa fa-exclamation-triangle text-red-500 mr-2"></i>
                            <span class="font-medium text-red-800">é”™è¯¯ä¿¡æ¯</span>
                        </div>
                        <p class="text-red-700 text-sm">${data.error}</p>
                    </div>
                `;
            }
            
            statusContent.innerHTML = statusHtml;
        }

        function displayResults(testData) {
            const resultsContent = document.getElementById('results-content');
            
            let resultsHtml = '';
            
            // éå†æµ‹è¯•æ•°æ®
            for (const [key, value] of Object.entries(testData)) {
                const isError = typeof value === 'string' && value.includes('å¤±è´¥');
                
                resultsHtml += `
                    <div class="border rounded-lg p-4 ${isError ? 'border-red-200 bg-red-50' : 'border-gray-200 bg-gray-50'}">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-medium text-gray-800">${getDataTypeName(key)}</h3>
                            <span class="px-2 py-1 rounded text-xs ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${isError ? 'å¤±è´¥' : 'æˆåŠŸ'}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600">
                            ${isError ? value : formatDataValue(value)}
                        </div>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = resultsHtml;
        }

        function displayRawData(data) {
            const rawData = document.getElementById('raw-data');
            rawData.textContent = JSON.stringify(data, null, 2);
        }

        function displayError(error) {
            const statusContent = document.getElementById('status-content');
            statusContent.innerHTML = `
                <div class="p-3 rounded-lg bg-red-50 border border-red-200">
                    <div class="flex items-center mb-2">
                        <i class="fa fa-exclamation-triangle text-red-500 mr-2"></i>
                        <span class="font-medium text-red-800">è¿æ¥å¤±è´¥</span>
                    </div>
                    <p class="text-red-700 text-sm">${error.message}</p>
                </div>
            `;
        }

        function getDataTypeName(key) {
            const names = {
                'user_info': 'ç”¨æˆ·ä¿¡æ¯',
                'today_activities': 'ä»Šæ—¥æ´»åŠ¨',
                'recent_activities': 'æœ€è¿‘æ´»åŠ¨',
                'heart_rate': 'å¿ƒç‡æ•°æ®',
                'steps': 'æ­¥æ•°æ•°æ®',
                'calories': 'å¡è·¯é‡Œæ•°æ®'
            };
            return names[key] || key;
        }

        function formatDataValue(value) {
            if (Array.isArray(value)) {
                return `å…± ${value.length} æ¡è®°å½•`;
            } else if (typeof value === 'object' && value !== null) {
                return `åŒ…å« ${Object.keys(value).length} ä¸ªå­—æ®µ`;
            } else {
                return String(value);
            }
        }
    </script>
</body>
</html>
