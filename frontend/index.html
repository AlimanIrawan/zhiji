<html lang="zh-CN"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>脂记 - 减脂进度追踪应用</title>
  <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 生产环境建议使用本地Tailwind CSS -->
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <!-- API配置 -->
  <script src="config.js"></script>
  <script src="api.js"></script>
  <script defer src="api-integration.js"></script>
  <!-- 统一的 Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6', // 蓝色
            secondary: '#10b981', // 绿色
            tertiary: '#f59e0b', // 橙色（用于还需努力天数）
            accent: '#f59e0b', // 橙色
            light: '#f3f4f6',
            dark: '#1f2937'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
    }
  </style>
  <style>
    /* 自定义样式 */
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: #f9fafb;
      padding-bottom: 60px; /* 为底部导航栏留出空间 */
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .progress-ring-circle {
      transition: stroke-dashoffset 0.35s;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
    
    .timeline-item {
      position: relative;
      padding-left: 28px;
      margin-bottom: 16px;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #3b82f6;
    }
    
    .timeline-item::after {
      content: '';
      position: absolute;
      left: 7px;
      top: 16px;
      width: 2px;
      height: calc(100% + 8px);
      background-color: #e5e7eb;
    }
    
    .timeline-item:last-child::after {
      display: none;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .calendar-day.has-data::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
    }
    
    .calendar-day.loss::after {
      background-color: #10b981;
    }
    
    .calendar-day.gain::after {
      background-color: #ef4444;
    }
    
    .food-item {
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
    .food-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .nav-tab {
      transition: all 0.3s ease;
    }
    
    .nav-tab.active {
      color: #3b82f6;
    }
    
    .nav-tab.active i {
      transform: scale(1.2);
    }
    
    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* 动画效果 */
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out forwards;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* 卡片悬浮效果 */
    .hover-card {
      transition: all 0.3s ease;
    }
    
    .hover-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* 移动端优化 */
    @media (max-width: 640px) {
      .mobile-flex-row {
        flex-direction: row !important;
      }
      .mobile-no-mb {
        margin-bottom: 0 !important;
      }
      .mobile-w-24 {
        width: 6rem !important;
        height: 6rem !important;
      }
      .mobile-text-xl {
        font-size: 1.25rem !important;
      }
      .mobile-text-sm {
        font-size: 0.75rem !important;
      }
      .mobile-p-2 {
        padding: 0.5rem !important;
      }
      .mobile-gap-2 {
        gap: 0.5rem !important;
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0f9f48a12fe34000bbe06bf2649ebbef~tplv-a9rns2rl98-image.image?rcl=20251019014617F030EFD8943FDD0B1D0C&amp;rk3s=8e244e95&amp;rrcfp=f06b921b&amp;x-expires=1763401621&amp;x-signature=p0u6OqeaxitEpc%2B3Scy5r560pVY%3D" alt="脂记Logo" class="h-8 w-8">
        <h1 class="text-xl font-bold text-primary">脂记</h1>
      </div>

    </div>
  </header>

  <!-- 主内容区域 -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <!-- 仪表盘页面 -->
    <section id="dashboard-tab" class="tab-content">
      <!-- 减脂进度卡片 - 移动端优化 -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6 hover-card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">减脂进度</h2>
        
        <!-- 完成度显示 - 包含环形进度条 -->
        <div class="flex flex-col items-center justify-center mb-6">
          <div class="relative w-48 h-48 mb-4">
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"></circle>
              <circle id="progress-circle" class="text-primary progress-ring-circle" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" stroke-dasharray="251.2" stroke-dashoffset="75.36"></circle>
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span id="progress-percentage" class="text-5xl font-bold text-primary">75%</span>
              <span class="text-xl text-gray-500">完成度</span>
            </div>
          </div>
        </div>
        
        <div class="flex flex-col md:flex-row items-center justify-between mobile-flex-row">
          <div class="w-full md:w-2/3 grid grid-cols-2 md:grid-cols-3 gap-4 mobile-gap-2">
            <div class="bg-gray-50 rounded-lg p-4 text-center mobile-p-2">
              <p class="text-sm text-gray-500 mb-1 mobile-text-sm">目标减脂</p>
              <p id="weight-goal" class="text-xl font-bold mobile-text-xl">5.0<span class="text-sm font-normal text-gray-500 mobile-text-sm">kg</span></p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center mobile-p-2">
              <p class="text-sm text-gray-500 mb-1 mobile-text-sm">已减脂</p>
              <p id="current-loss" class="text-xl font-bold text-secondary mobile-text-xl">3.75<span class="text-sm font-normal text-gray-500 mobile-text-sm">kg</span></p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center mobile-p-2">
              <p class="text-sm text-gray-500 mb-1 mobile-text-sm">还需努力</p>
              <p id="remaining-days" class="text-xl font-bold text-tertiary mobile-text-xl">7<span class="text-sm font-normal text-gray-500 mobile-text-sm">天</span></p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center mobile-p-2 col-span-1 md:col-span-3">
              <p class="text-sm text-gray-500 mb-1 mobile-text-sm">已记录天数</p>
              <p id="recorded-days" class="text-xl font-bold mobile-text-xl">21<span class="text-sm font-normal text-gray-500 mobile-text-sm">天</span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- 今日数据卡片 -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6 hover-card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">今日数据</h2>
        <div>
          <!-- 今日脂肪变化 -->
          <div class="bg-gray-50 rounded-xl p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between">
              <div>
                <h3 class="text-md font-medium text-gray-600">今日脂肪变化</h3>
                <span class="text-sm text-gray-500 flex items-center mt-1">
                  <i id="fat-change-icon" class="fa fa-arrow-down text-green-600 mr-1"></i> 
                  <span id="fat-change-status">减脂中</span>
                </span>
              </div>
              <div class="flex items-start justify-end pt-1">
                <span id="fat-change" class="text-3xl font-bold text-green-600">+0.00g</span>
              </div>
            </div>
          </div>
          
          <!-- 热量收支 -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-md font-medium text-gray-600">热量收支</h3>
              <span id="calorie-balance" class="text-sm font-medium px-2 py-1 rounded-full bg-green-100 text-green-800">
                <i class="fa fa-arrow-down mr-1"></i>500 kcal
              </span>
            </div>
            
            <!-- 摄入与消耗对比 -->
            <div class="relative h-16 bg-gray-200 rounded-full overflow-hidden mb-4">
              <div class="absolute top-0 left-0 h-full bg-red-500 flex items-center justify-end pr-4" id="calories-in-bar" style="width: 44%">
                <span id="calories-in" class="text-white font-medium">1800 kcal</span>
              </div>
              <div class="absolute top-0 right-0 h-full bg-green-500 flex items-center justify-start pl-4" id="calories-out-bar" style="width: 56%">
                <span id="calories-out" class="text-white font-medium">2300 kcal</span>
              </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-xs text-gray-500 mb-1">蛋白质</p>
                <p id="protein" class="text-sm font-medium">120<span class="text-xs text-gray-500">g</span></p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-xs text-gray-500 mb-1">碳水</p>
                <p id="carbs" class="text-sm font-medium">150<span class="text-xs text-gray-500">g</span></p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-xs text-gray-500 mb-1">脂肪</p>
                <p id="fat" class="text-sm font-medium">65<span class="text-xs text-gray-500">g</span></p>
              </div>
            </div>
          </div>
          
          <!-- 今日训练 -->
          <div>
            <h3 class="text-md font-medium text-gray-600 mb-4">今日训练</h3>
            <div class="bg-gray-50 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                    <i class="fa fa-running text-primary"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium">有氧运动</p>
                    <p class="text-xs text-gray-500">30分钟</p>
                  </div>
                </div>
                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                  <i class="fa fa-check text-secondary"></i>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center mr-3">
                    <i class="fa fa-dumbbell text-accent"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium">力量训练</p>
                    <p class="text-xs text-gray-500">45分钟</p>
                  </div>
                </div>
                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                  <i class="fa fa-check text-secondary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 月日历视图 -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6 hover-card">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-700">日脂肪变化</h2>
          <div class="flex space-x-2">
            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-all-300">
              <i class="fa fa-chevron-left text-gray-500"></i>
            </button>
            <span id="current-month" class="text-sm font-medium">2025年7月</span>
            <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 transition-all-300">
              <i class="fa fa-chevron-right text-gray-500"></i>
            </button>
          </div>
        </div>
        
        <!-- 星期标题 -->
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center text-xs text-gray-500">日</div>
          <div class="text-center text-xs text-gray-500">一</div>
          <div class="text-center text-xs text-gray-500">二</div>
          <div class="text-center text-xs text-gray-500">三</div>
          <div class="text-center text-xs text-gray-500">四</div>
          <div class="text-center text-xs text-gray-500">五</div>
          <div class="text-center text-xs text-gray-500">六</div>
        </div>
        
        <!-- 日历网格 -->
        <div id="calendar-grid" class="grid grid-cols-7 gap-1">
          <!-- 日历内容将通过JavaScript动态生成 -->
        </div>
        
        <div class="mt-4 flex items-center justify-center space-x-6">
          <div class="flex items-center">
            <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
            <span class="text-xs text-gray-500">减脂</span>
          </div>
          <div class="flex items-center">
            <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
            <span class="text-xs text-gray-500">增脂</span>
          </div>
        </div>
      </div>


    </section>

    <!-- 卡路里摄入记录页面 -->
    <section id="calorie-tab" class="tab-content active">
      <!-- 记录表单 -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">添加饮食记录</h2>
        
        <!-- 图片上传区域 -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">上传食物图片</label>
          <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-all-300 cursor-pointer">
            <input type="file" id="food-image" class="hidden" accept="image/*" style="position: absolute; left: -9999px; opacity: 0;">
            <div id="image-preview" class="hidden mb-4">
              <img src="" alt="食物预览" class="max-h-40 mx-auto rounded-lg">
            </div>
            <div id="upload-placeholder">
              <i class="fa fa-camera text-gray-400 text-3xl mb-2"></i>
              <p class="text-sm text-gray-500">点击上传或拍照</p>
              <p class="text-xs text-gray-400 mt-1">支持 JPG、PNG 格式</p>
            </div>
          </div>
        </div>
        
        <!-- 食物描述 -->
        <div class="mb-6">
          <label for="food-description" class="block text-sm font-medium text-gray-700 mb-2">食物描述</label>
          <textarea id="food-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="例如：午餐：炸鸡排、米饭、蔬菜"></textarea>
        </div>
        
        <!-- 历史记录快捷选择 -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <p class="text-sm font-medium text-gray-700">历史记录</p>
            <span class="text-xs text-gray-500">点击快速添加</span>
          </div>
          <div id="history-records" class="space-y-3 max-h-96 overflow-y-auto">
            <!-- 历史记录将通过JavaScript动态生成 -->
            <div class="text-center text-gray-500 py-4">
              暂无历史记录
            </div>
          </div>
        </div>
        
        <!-- 提交按钮 -->
        <button id="analyze-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-all-300 flex items-center justify-center">
          <i class="fa fa-search-plus mr-2"></i>
          分析营养成分
        </button>
      </div>
      
      <!-- 分析结果 -->
      <div id="analysis-result" class="bg-white rounded-xl shadow-md p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-700">分析结果</h2>
          <span id="result-time" class="text-xs text-gray-500">2025-07-21 12:30</span>
        </div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">总热量</p>
            <p id="result-calories" class="text-xl font-bold text-primary">650<span class="text-sm font-normal text-gray-500">kcal</span></p>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">蛋白质</p>
            <p id="result-protein" class="text-xl font-bold text-secondary">35<span class="text-sm font-normal text-gray-500">g</span></p>
          </div>
          <div class="bg-orange-50 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">碳水/脂肪</p>
            <p id="result-macros" class="text-xl font-bold text-accent">50/30<span class="text-sm font-normal text-gray-500">g</span></p>
          </div>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <h3 class="text-sm font-medium text-gray-700 mb-2">AI 建议</h3>
          <p id="result-advice" class="text-sm text-gray-600">
            下午可以增加一些有氧运动，帮助消耗多余热量。
          </p>
        </div>
        
        <div class="flex space-x-3">
          <button id="save-record" class="flex-1 bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
            保存记录
          </button>
          <button id="cancel-record" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
            取消
          </button>
        </div>
      </div>
      
      <!-- 饮食记录时间轴 -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-700">饮食记录</h2>
          <div class="relative">
            <input type="date" id="record-date" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-primary focus:border-primary">
          </div>
        </div>
        
        <div id="records-timeline" class="space-y-4">
          <!-- 记录项 1 -->
          <div class="timeline-item bg-gray-50 rounded-lg p-4 relative">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500 delete-record" data-id="1">
              <i class="fa fa-trash-o"></i>
            </button>
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-sm font-medium">午餐：炸鸡排、米饭、蔬菜</h3>
              <span class="text-xs text-gray-500">12:30</span>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-2">
              <div class="text-center">
                <p class="text-xs text-gray-500">热量</p>
                <p class="text-sm font-medium">650<span class="text-xs">kcal</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">蛋白质</p>
                <p class="text-sm font-medium">35<span class="text-xs">g</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">碳水</p>
                <p class="text-sm font-medium">50<span class="text-xs">g</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">脂肪</p>
                <p class="text-sm font-medium">30<span class="text-xs">g</span></p>
              </div>
            </div>
            <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
              <i class="fa fa-lightbulb-o mr-1"></i> 下午可以增加一些有氧运动，帮助消耗多余热量。
            </div>
          </div>
          
          <!-- 记录项 2 -->
          <div class="timeline-item bg-gray-50 rounded-lg p-4 relative">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500 delete-record" data-id="2">
              <i class="fa fa-trash-o"></i>
            </button>
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-sm font-medium">早餐：全麦面包、鸡蛋、牛奶</h3>
              <span class="text-xs text-gray-500">08:00</span>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-2">
              <div class="text-center">
                <p class="text-xs text-gray-500">热量</p>
                <p class="text-sm font-medium">350<span class="text-xs">kcal</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">蛋白质</p>
                <p class="text-sm font-medium">20<span class="text-xs">g</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">碳水</p>
                <p class="text-sm font-medium">40<span class="text-xs">g</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">脂肪</p>
                <p class="text-sm font-medium">12<span class="text-xs">g</span></p>
              </div>
            </div>
            <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
              <i class="fa fa-lightbulb-o mr-1"></i> 早餐搭配均衡，蛋白质充足，有助于肌肉维持。
            </div>
          </div>
        </div>
        
        <!-- 无记录状态 -->
        <div id="no-records" class="hidden text-center py-8">
          <i class="fa fa-utensils text-gray-300 text-4xl mb-3"></i>
          <p class="text-gray-500">今天还没有饮食记录</p>
          <p class="text-xs text-gray-400 mt-1">点击上方按钮添加记录</p>
        </div>
      </div>
    </section>

    <!-- 设置页面 -->
    <section id="settings-tab" class="tab-content">
      <!-- 用户信息卡片 -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div class="flex items-center justify-center py-4">
          <div class="text-center">
            <p class="text-sm text-gray-500 mb-1">开始减脂</p>
            <p class="text-xl font-semibold">2025-07-01</p>
          </div>
        </div>
      </div>
      
      <!-- 减脂目标设置 -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">减脂目标</h2>
        <div class="mb-4">
          <label for="weight-goal-input" class="block text-sm font-medium text-gray-700 mb-2">目标减脂重量 (kg)</label>
          <div class="flex items-center">
            <input type="range" id="weight-goal-input" min="1" max="10" step="0.5" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            <span id="weight-goal-value" class="ml-3 text-sm font-medium min-w-[3rem] text-center">5.0</span>
          </div>
        </div>
        <button id="save-goal" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
          保存目标
        </button>
      </div>
      
      <!-- Garmin 连接状态 -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Garmin 连接</h2>
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-sm font-medium">连接状态</p>
            <p id="garmin-status" class="text-sm text-green-600">已连接</p>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between mb-2">
            <p class="text-sm text-gray-500">最后同步时间</p>
            <p id="last-sync-time" class="text-sm font-medium">2025-07-21 08:30</p>
          </div>
          <div class="flex justify-between">
            <p class="text-sm text-gray-500">同步数据</p>
            <p class="text-sm font-medium">步数、心率、卡路里消耗</p>
          </div>
        </div>
        <button id="sync-garmin" class="w-full mt-4 bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300 flex items-center justify-center">
          <i class="fa fa-refresh mr-2"></i>
          立即同步
        </button>
      </div>
      
      <!-- 数据存储 -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">数据存储</h2>
        <div class="bg-blue-50 rounded-lg p-4">
          <div class="flex items-start">
            <div class="flex-shrink-0 mt-0.5">
              <i class="fa fa-cloud text-primary text-xl"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-blue-800">数据已同步至云端</h3>
              <p class="mt-1 text-sm text-blue-700">
                您的所有减脂数据已安全存储在云端，可在多设备间同步访问。
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 底部导航栏 -->
  <nav class="bg-white shadow-lg border-t border-gray-200 fixed bottom-0 left-0 right-0 z-10">
    <div class="container mx-auto px-4">
      <div class="flex justify-around py-3">
        <button class="nav-tab flex flex-col items-center" data-tab="dashboard-tab">
          <i class="fa fa-tachometer text-lg"></i>
          <span class="text-xs mt-1">仪表盘</span>
        </button>
        <button class="nav-tab active flex flex-col items-center" data-tab="calorie-tab">
          <i class="fa fa-cutlery text-lg"></i>
          <span class="text-xs mt-1">饮食记录</span>
        </button>
        <button class="nav-tab flex flex-col items-center" data-tab="settings-tab">
          <i class="fa fa-user text-lg"></i>
          <span class="text-xs mt-1">我的</span>
        </button>
      </div>
    </div>
  </nav>
  


  <!-- 模拟AI分析的加载弹窗 -->
  <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-xs w-full mx-4">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">AI 正在分析...</h3>
        <p id="loading-text" class="text-sm text-gray-500">正在识别食物成分和计算营养值</p>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // 数据模型
    const appData = {
      userProfile: {
        id: "user123",
        name: "用户名",
        weightGoal: 5000, // 目标减脂克数
        currentWeightLoss: 3750, // 当前已减脂克数
        startDate: "2025-07-01", // 开始日期
        garminConnected: true, // Garmin连接状态
        lastSync: "2025-07-21T08:30:00" // 最后同步时间
      },
      foodRecords: [
        {
          id: "rec1",
          date: "2025-07-21",
          time: "12:30",
          description: "午餐：炸鸡排、米饭、蔬菜",
          calories: 650,
          protein: 35, // 克
          carbs: 50, // 克
          fat: 30, // 克
          aiAdvice: "下午可以增加一些有氧运动，帮助消耗多余热量。",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        },
        {
          id: "rec2",
          date: "2025-07-21",
          time: "08:00",
          description: "早餐：全麦面包、鸡蛋、牛奶",
          calories: 350,
          protein: 20, // 克
          carbs: 40, // 克
          fat: 12, // 克
          aiAdvice: "早餐搭配均衡，蛋白质充足，有助于肌肉维持。",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        },
        {
          id: "rec3",
          date: "2025-07-20",
          time: "19:00",
          description: "晚餐：烤鱼、蔬菜沙拉",
          calories: 450,
          protein: 40, // 克
          carbs: 20, // 克
          fat: 20, // 克
          aiAdvice: "晚餐营养均衡，脂肪含量适中，有助于夜间脂肪燃烧。",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        },
        {
          id: "rec4",
          date: "2025-07-20",
          time: "12:30",
          description: "午餐：炸鸡排、米饭、蔬菜",
          calories: 650,
          protein: 35, // 克
          carbs: 50, // 克
          fat: 30, // 克
          aiAdvice: "下午可以增加一些有氧运动，帮助消耗多余热量。",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        },
        {
          id: "rec5",
          date: "2025-07-19",
          time: "12:30",
          description: "午餐：炸鸡排、米饭、蔬菜",
          calories: 650,
          protein: 35, // 克
          carbs: 50, // 克
          fat: 30, // 克
          aiAdvice: "下午可以增加一些有氧运动，帮助消耗多余热量。",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        }
      ],
      dailySummaries: [
        {
          date: "2025-07-21",
          totalCaloriesIn: 1800,
          totalProtein: 120,
          totalCarbs: 150,
          totalFat: 65,
          totalCaloriesOut: 2300,
          trainingType: "both", // none, A, S, both
          fatChange: -40.56 // 克，负值为减脂
        }
      ],
      // 保存当前编辑的记录
      currentRecord: null
    };

    // 添加全局错误处理
    window.addEventListener('error', function(e) {
      console.error('JavaScript错误:', e.message, '在文件:', e.filename, '行号:', e.lineno);
      alert('发生错误: ' + e.message);
    });
    
    // DOM 加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化应用
      initializeApp();
      
      // 初始化底部导航
      initNavigation();
      
      // 初始化仪表盘
      initDashboard();
      
      // 初始化卡路里记录页面
      initCalorieRecord();
      
      // 初始化设置页面
      initSettings();
      
      // 初始化模态框
      initModals();
      
      // 设置日期选择器默认值为今天
      const recordDate = document.getElementById('record-date');
      if (recordDate) {
        const today = new Date().toISOString().split('T')[0];
        recordDate.value = today;
        console.log('🔍 [Init] 设置日期选择器默认值:', today);
      }
      
      // 手动触发一次饮食记录更新
      updateCalorieRecords();
      
      // 为底部导航栏添加直接的点击事件绑定
      document.querySelector('[data-tab="dashboard-tab"]').addEventListener('click', function() {
        switchTab('dashboard-tab');
      });
      
      document.querySelector('[data-tab="calorie-tab"]').addEventListener('click', function() {
        switchTab('calorie-tab');
      });
      
      document.querySelector('[data-tab="settings-tab"]').addEventListener('click', function() {
        switchTab('settings-tab');
      });
    });
    
    // 切换标签页
    function switchTab(tabId) {
      try {
        console.log('尝试切换到标签页:', tabId);
        
        // 检查标签页元素是否存在
        const tabElement = document.getElementById(tabId);
        if (!tabElement) {
          console.error('标签页元素不存在:', tabId);
          return;
        }
        
        // 移除所有活动状态
        document.querySelectorAll('.nav-tab').forEach(t => {
          console.log('移除活动状态:', t.getAttribute('data-tab'));
          t.classList.remove('active');
        });
        
        document.querySelectorAll('.tab-content').forEach(c => {
          console.log('隐藏标签页:', c.id);
          c.classList.remove('active');
        });
        
        // 添加当前活动状态
        const navTab = document.querySelector(`[data-tab="${tabId}"]`);
        if (navTab) {
          console.log('添加活动状态到导航按钮:', tabId);
          navTab.classList.add('active');
        } else {
          console.error('导航按钮不存在:', tabId);
        }
        
        console.log('显示标签页:', tabId);
        tabElement.classList.add('active');
        
        // 验证标签页是否显示
        setTimeout(() => {
          const isActive = tabElement.classList.contains('active');
          console.log('标签页', tabId, '是否显示:', isActive);
          
          if (!isActive) {
            console.error('标签页未显示，手动添加active类');
            tabElement.classList.add('active');
          }
        }, 100);
        
        // 滚动到顶部
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        console.log('成功切换到标签页:', tabId);
      } catch (error) {
        console.error('切换标签页时发生错误:', error);
        alert('切换页面时发生错误: ' + error.message);
      }
    }

    // 初始化应用
    async function initializeApp() {
      // 设置当前日期
      const today = new Date().toISOString().split('T')[0];
      const recordDateEl = document.getElementById('record-date');
      if (recordDateEl) {
        recordDateEl.value = today;
      }
      
      // 从后端加载数据
      console.log('🚀 初始化应用，从后端加载数据...');
      try {
        const response = await window.apiClient.getRecords();
        if (response.success && response.data) {
          appData.foodRecords = response.data;
          console.log('✅ 初始化数据加载成功，记录数量:', appData.foodRecords.length);
        }
      } catch (error) {
        console.error('❌ 初始化数据加载失败:', error);
        // 如果后端加载失败，使用空数组
        appData.foodRecords = [];
      }
      
      // 更新UI
      updateUI();
    }

    // 检查本地存储
    function checkLocalStorage() {
      // 这里可以添加检查本地存储的逻辑
      // 如果有数据，加载本地数据
      // 如果没有数据，使用默认数据
    }

    // 更新UI
    function updateUI() {
      // 更新仪表盘
      updateDashboard();
      
      // 更新卡路里记录
      updateCalorieRecords();
      
      // 更新设置页面
      updateSettings();
    }

    // 初始化底部导航 - 保留但添加调试信息
    function initNavigation() {
      console.log('初始化底部导航');
      const navTabs = document.querySelectorAll('.nav-tab');
      
      console.log('找到导航按钮数量:', navTabs.length);
      
      navTabs.forEach(tab => {
        const tabId = tab.getAttribute('data-tab');
        console.log('为导航按钮添加点击事件:', tabId);
        
        tab.addEventListener('click', function(e) {
          console.log('导航按钮被点击:', tabId);
          
          // 直接调用切换函数
          switchTab(tabId);
          
          // 阻止事件冒泡和默认行为
          e.stopPropagation();
          e.preventDefault();
        });
      });
    }

    // 初始化仪表盘
    function initDashboard() {
      // 更新进度环
      updateProgressRing();
      
      // 更新今日数据
      updateTodayData();
      
      // 初始化月日历视图
      initCalendarView();
      
      // 生成当前月的模拟数据
      const today = new Date();
      generateCalendarMockData(today.getFullYear(), today.getMonth());
      
      // 更新AI建议
      updateAIAdvice();
    }

    // 更新仪表盘
    function updateDashboard() {
      // 更新进度环
      updateProgressRing();
      
      // 更新今日数据
      updateTodayData();
    }

    // 更新进度环
    function updateProgressRing() {
      const { weightGoal, currentWeightLoss, startDate } = appData.userProfile;
      const progress = (currentWeightLoss / weightGoal) * 100;
      
      // 更新百分比文本
      document.getElementById('progress-percentage').textContent = `${Math.round(progress)}%`;
      
      // 更新进度环
      const circle = document.getElementById('progress-circle');
      const radius = circle.r.baseVal.value;
      const circumference = radius * 2 * Math.PI;
      
      circle.style.strokeDasharray = `${circumference} ${circumference}`;
      const offset = circumference - (progress / 100) * circumference;
      circle.style.strokeDashoffset = offset;
      
      // 更新目标和当前减脂量
      document.getElementById('weight-goal').textContent = `${(weightGoal / 1000).toFixed(1)}`;
      document.getElementById('current-loss').textContent = `${(currentWeightLoss / 1000).toFixed(2)}`;
      
      // 计算已记录天数
      const start = new Date(startDate);
      const today = new Date();
      const diffTime = Math.abs(today - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      const recordedDaysEl = document.getElementById('recorded-days');
      if (recordedDaysEl) {
        recordedDaysEl.textContent = `${diffDays}`;
      }
      
      // 计算剩余天数（基于用户的平均减脂速度）
      const averageDailyLoss = diffDays > 0 ? currentWeightLoss / diffDays : 0; // 克/天
      const remainingWeight = weightGoal - currentWeightLoss;
      const remainingDays = averageDailyLoss > 0 ? Math.ceil(remainingWeight / averageDailyLoss) : 0;
      
      const remainingDaysEl = document.getElementById('remaining-days');
      if (remainingDaysEl) {
        remainingDaysEl.textContent = `${remainingDays}`;
      }
    }

    // 更新今日数据
    function updateTodayData() {
      const today = new Date().toISOString().split('T')[0];
      const summary = appData.dailySummaries.find(s => s.date === today) || {
        totalCaloriesIn: 0,
        totalProtein: 0,
        totalCarbs: 0,
        totalFat: 0,
        totalCaloriesOut: 2000,
        trainingType: "none",
        fatChange: 0
      };
      
      // 更新摄入和消耗
      const caloriesInEl = document.getElementById('calories-in');
      const caloriesOutEl = document.getElementById('calories-out');
      if (caloriesInEl) {
        caloriesInEl.textContent = `${summary.totalCaloriesIn} kcal`;
      }
      if (caloriesOutEl) {
        caloriesOutEl.textContent = `${summary.totalCaloriesOut} kcal`;
      }
      
      // 更新摄入消耗对比条
      const caloriesInBar = document.getElementById('calories-in-bar');
      const caloriesOutBar = document.getElementById('calories-out-bar');
      
      // 计算总热量
      const totalCalories = summary.totalCaloriesIn + summary.totalCaloriesOut;
      
      // 计算百分比
      let inPercentage = 0;
      let outPercentage = 0;
      
      if (totalCalories > 0) {
        inPercentage = (summary.totalCaloriesIn / totalCalories) * 100;
        outPercentage = (summary.totalCaloriesOut / totalCalories) * 100;
      }
      
      // 更新宽度
      caloriesInBar.style.width = `${inPercentage}%`;
      caloriesOutBar.style.width = `${outPercentage}%`;
      
      // 确保文字不重叠
      if (inPercentage > 10) {
        caloriesInBar.querySelector('span').style.display = 'block';
      } else {
        caloriesInBar.querySelector('span').style.display = 'none';
      }
      
      if (outPercentage > 10) {
        caloriesOutBar.querySelector('span').style.display = 'block';
      } else {
        caloriesOutBar.querySelector('span').style.display = 'none';
      }
      
      // 更新宏量营养素
      const proteinEl = document.getElementById('protein');
      const carbsEl = document.getElementById('carbs');
      const fatEl = document.getElementById('fat');
      if (proteinEl) {
        proteinEl.textContent = `${summary.totalProtein}`;
      }
      if (carbsEl) {
        carbsEl.textContent = `${summary.totalCarbs}`;
      }
      if (fatEl) {
        fatEl.textContent = `${summary.totalFat}`;
      }
      
      // 更新热量平衡
      const calorieBalance = document.getElementById('calorie-balance');
      const balance = summary.totalCaloriesOut - summary.totalCaloriesIn;
      
      if (balance > 0) {
        calorieBalance.innerHTML = `<i class="fa fa-arrow-down mr-1"></i>${balance} kcal`;
        calorieBalance.className = 'text-sm font-medium px-2 py-1 rounded-full bg-green-100 text-green-800';
      } else {
        calorieBalance.innerHTML = `<i class="fa fa-arrow-up mr-1"></i>${Math.abs(balance)} kcal`;
        calorieBalance.className = 'text-sm font-medium px-2 py-1 rounded-full bg-red-100 text-red-800';
      }
      
      // 更新脂肪变化
      const fatChangeEl = document.getElementById('fat-change');
      const fatChangeIcon = document.getElementById('fat-change-icon');
      const fatChangeStatus = document.getElementById('fat-change-status');
      
      if (summary.fatChange < 0) {
        // 减脂
        fatChangeEl.textContent = `-${Math.abs(summary.fatChange).toFixed(2)}g`;
        fatChangeEl.className = 'text-3xl font-bold text-green-600';
        fatChangeIcon.className = 'fa fa-arrow-down text-green-600 mr-1';
        fatChangeIcon.textContent = ''; // 清空文本内容，只保留图标
        fatChangeStatus.textContent = '减脂中';
      } else {
        // 增脂
        fatChangeEl.textContent = `+${summary.fatChange.toFixed(2)}g`;
        fatChangeEl.className = 'text-3xl font-bold text-red-600';
        fatChangeIcon.className = 'fa fa-arrow-up text-red-600 mr-1';
        fatChangeIcon.textContent = ''; // 清空文本内容，只保留图标
        fatChangeStatus.textContent = '增脂中';
      }
    }

    // 更新月日历视图
    function updateCalendarView(year, month) {
      const calendarGrid = document.getElementById('calendar-grid');
      const currentMonthEl = document.getElementById('current-month');
      
      // 清空日历
      calendarGrid.innerHTML = '';
      
      // 设置当前月份显示
      const date = new Date(year, month);
      const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
      currentMonthEl.textContent = `${year}年${monthNames[month]}`;
      
      // 获取当月第一天是星期几
      const firstDay = new Date(year, month, 1).getDay();
      
      // 获取当月天数
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // 添加空白格子
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        calendarGrid.appendChild(emptyDay);
      }
      
      // 添加日期格子
      for (let day = 1; day <= daysInMonth; day++) {
        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const summary = appData.dailySummaries.find(s => s.date === dateString);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        
        if (summary) {
          if (summary.fatChange < 0) {
            dayEl.classList.add('loss');
          } else if (summary.fatChange > 0) {
            dayEl.classList.add('gain');
          }
        }
        
        const dayText = document.createElement('p');
        dayText.className = 'text-sm';
        dayText.textContent = day;
        
        dayEl.appendChild(dayText);
        calendarGrid.appendChild(dayEl);
      }
      
      // 生成模拟数据填充日历
      generateCalendarMockData(year, month);
    }
    
    // 生成日历模拟数据
    function generateCalendarMockData(year, month) {
      // 确保有足够的模拟数据
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // 为每个日期生成随机脂肪变化数据
      for (let day = 1; day <= daysInMonth; day++) {
        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // 如果已经有数据，跳过
        if (appData.dailySummaries.find(s => s.date === dateString)) {
          continue;
        }
        
        // 随机生成脂肪变化（-50到10克之间）
        const fatChange = (Math.random() * 60 - 50).toFixed(2);
        
        // 添加到数据中
        appData.dailySummaries.push({
          date: dateString,
          totalCaloriesIn: Math.floor(Math.random() * 500) + 1500,
          totalProtein: Math.floor(Math.random() * 50) + 80,
          totalCarbs: Math.floor(Math.random() * 80) + 100,
          totalFat: Math.floor(Math.random() * 30) + 40,
          totalCaloriesOut: Math.floor(Math.random() * 500) + 2000,
          trainingType: ["none", "A", "S", "both"][Math.floor(Math.random() * 4)],
          fatChange: parseFloat(fatChange)
        });
      }
    }
    
    // 初始化月日历视图
    function initCalendarView() {
      const today = new Date();
      let currentYear = today.getFullYear();
      let currentMonth = today.getMonth();
      
      // 更新日历
      updateCalendarView(currentYear, currentMonth);
      
      // 上一个月按钮点击
      document.getElementById('prev-month').addEventListener('click', function() {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        updateCalendarView(currentYear, currentMonth);
      });
      
      // 下一个月按钮点击
      document.getElementById('next-month').addEventListener('click', function() {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateCalendarView(currentYear, currentMonth);
      });
    }

    // 更新AI建议
    function updateAIAdvice() {
      const adviceOptions = [
        "今天的训练和饮食搭配很好！继续保持这个节奏，预计还需要7天就能达成目标。晚上可以适当放松，但不要熬夜。",
        "你的减脂进度不错，但蛋白质摄入略低。建议增加鸡胸肉、鱼或豆类等高蛋白食物的摄入，有助于肌肉维持。",
        "今天的热量赤字适中，训练强度也很好。记得多喝水，保持身体水分充足，有助于新陈代谢。",
        "你的碳水化合物摄入有点高，特别是精制碳水。建议替换为全麦、燕麦等复合碳水化合物，饱腹感更强。",
        "本周减脂效果显著！周末可以适当放松饮食，但不要完全放纵，以免影响整体进度。"
      ];
      
      const randomAdvice = adviceOptions[Math.floor(Math.random() * adviceOptions.length)];
      const aiAdviceEl = document.getElementById('ai-advice');
      if (aiAdviceEl) {
        aiAdviceEl.textContent = randomAdvice;
      } else {
        console.warn('⚠️ 找不到 ai-advice 元素');
      }
    }

    // 初始化卡路里记录页面
    function initCalorieRecord() {
      console.log('开始初始化上传功能...');
      
      // 图片上传 - 重新实现
      const foodImage = document.getElementById('food-image');
      const imagePreview = document.getElementById('image-preview');
      const uploadPlaceholder = document.getElementById('upload-placeholder');
      const uploadArea = document.getElementById('upload-area');
      
      // 检查元素是否存在
      if (!foodImage) {
        console.error('❌ 找不到文件输入框');
        return;
      }
      if (!imagePreview) {
        console.error('❌ 找不到图片预览区域');
        return;
      }
      if (!uploadPlaceholder) {
        console.error('❌ 找不到上传占位符');
        return;
      }
      if (!uploadArea) {
        console.error('❌ 找不到上传区域');
        return;
      }
      
      console.log('✅ 所有上传元素已找到');
      
      // 创建新的上传处理函数 - 使用动态创建文件输入框的方法
      function handleUploadClick(e) {
        console.log('🖱️ 上传区域被点击');
        e.preventDefault();
        e.stopPropagation();
        
        console.log('📁 创建新的文件输入框...');
        
        // 创建新的文件输入框（测试证明这个方法有效）
        const newFileInput = document.createElement('input');
        newFileInput.type = 'file';
        newFileInput.accept = 'image/*';
        newFileInput.style.position = 'absolute';
        newFileInput.style.left = '-9999px';
        newFileInput.style.opacity = '0';
        
        // 添加到页面
        document.body.appendChild(newFileInput);
        
        // 绑定文件选择事件
        newFileInput.addEventListener('change', function(e) {
          console.log('📂 新文件输入框触发');
          const file = e.target.files[0];
          
          if (file) {
            console.log('✅ 文件已选择:', file.name, '大小:', file.size, 'bytes');
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
              alert('请选择图片文件');
              return;
            }
            
            // 读取文件并显示预览
            const reader = new FileReader();
            reader.onload = function(e) {
              console.log('🖼️ 图片加载完成');
              
              // 显示图片预览
              const img = imagePreview.querySelector('img');
              if (img) {
                img.src = e.target.result;
                imagePreview.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                console.log('✅ 图片预览已显示');
              }
            };
            
            reader.readAsDataURL(file);
          }
          
          // 清理临时文件输入框
          setTimeout(() => {
            if (document.body.contains(newFileInput)) {
              document.body.removeChild(newFileInput);
              console.log('🧹 已清理临时文件输入框');
            }
          }, 1000);
        });
        
        // 触发点击
        try {
          newFileInput.click();
          console.log('✅ 新文件选择器已触发');
        } catch (error) {
          console.error('❌ 新文件选择器触发失败:', error);
          // 清理
          if (document.body.contains(newFileInput)) {
            document.body.removeChild(newFileInput);
          }
        }
      }
      
      // 这个函数现在不需要了，因为文件选择逻辑已经移到 handleUploadClick 中
      function handleFileSelect(e) {
        console.log('📂 原始文件选择器触发（应该不会用到）');
        // 这个函数保留以防万一，但主要逻辑已移到 handleUploadClick 中
      }
      
      // 绑定事件
      uploadArea.addEventListener('click', handleUploadClick);
      foodImage.addEventListener('change', handleFileSelect);
      
      console.log('✅ 上传功能初始化完成');
      
      // 加载历史记录
      if (typeof loadHistoryRecords === 'function') {
        loadHistoryRecords();
      }
      
      // 历史记录点击事件委托
      const historyRecords = document.getElementById('history-records');
      if (historyRecords) {
        historyRecords.addEventListener('click', function(e) {
          const recordItem = e.target.closest('.history-record-item');
          if (recordItem) {
            const recordId = recordItem.getAttribute('data-id');
            if (typeof loadRecordToForm === 'function') {
              loadRecordToForm(recordId);
            }
          }
        });
      }
      
      // AI分析函数 - 移到全局作用域
      async function callAIAnalysis(imageData, desc) {
        try {
          console.log('🔄 开始AI分析...');
          console.log('📝 描述:', desc);
          console.log('🖼️ 图片:', imageData ? '有图片' : '无图片');
          console.log('🖼️ 图片数据长度:', imageData ? imageData.length : 0);
          
          // 检查是否有图片数据但没有传递给AI
          if (!imageData && foodImage.files && foodImage.files[0]) {
            console.error('❌ 图片文件存在但没有传递给AI分析！');
            alert('图片处理失败，请重新上传图片');
            hideLoadingModal();
            return;
          }
          
          // 调用真实AI分析（异步）
          const result = await simulateAIAnalysis(imageData, desc);
          
          console.log('✅ AI分析完成，结果:', result);
          
          // 隐藏加载弹窗
          hideLoadingModal();
          
          // 显示分析结果
          showAnalysisResult(result);
        } catch (error) {
          console.error('❌ AI分析失败:', error);
          hideLoadingModal();
          alert('AI分析失败: ' + error.message);
        }
      }
      
      // 分析按钮点击
      const analyzeBtn = document.getElementById('analyze-btn');
      analyzeBtn.addEventListener('click', function() {
        const description = document.getElementById('food-description').value;
        const foodImage = document.getElementById('food-image');
        const imagePreview = document.getElementById('image-preview');
        const img = imagePreview ? imagePreview.querySelector('img') : null;
        
        console.log('🔍 [Analyze] 开始分析检查...');
        console.log('🔍 [Analyze] 描述:', description);
        console.log('🔍 [Analyze] foodImage元素:', foodImage);
        console.log('🔍 [Analyze] foodImage.files:', foodImage ? foodImage.files : 'N/A');
        console.log('🔍 [Analyze] files.length:', foodImage && foodImage.files ? foodImage.files.length : 0);
        console.log('🔍 [Analyze] 图片预览元素:', imagePreview);
        console.log('🔍 [Analyze] 图片元素:', img);
        console.log('🔍 [Analyze] 图片是否隐藏:', imagePreview ? imagePreview.classList.contains('hidden') : 'N/A');
        console.log('🔍 [Analyze] 图片src:', img ? img.src : 'N/A');
        
        // 检查是否有图片（通过预览或文件输入框）
        const hasImage = (img && img.src && !imagePreview.classList.contains('hidden')) || 
                        (foodImage && foodImage.files && foodImage.files.length > 0);
        
        if (!description && !hasImage) {
          console.log('❌ [Analyze] 没有描述也没有图片');
          alert('请上传图片或填写食物描述');
          return;
        }
        
        // 显示加载弹窗
        showLoadingModal('正在分析食物成分...');
        
        // 获取图片数据
        let imageBase64 = null;
        
        // 优先从文件输入框获取
        if (foodImage && foodImage.files && foodImage.files[0]) {
          console.log('🖼️ 从文件输入框读取图片...');
          const reader = new FileReader();
          reader.onload = function(e) {
            imageBase64 = e.target.result;
            console.log('🖼️ 图片读取完成，大小:', imageBase64.length, '字符');
            // 调用真实AI分析
            callAIAnalysis(imageBase64, description);
          };
          reader.readAsDataURL(foodImage.files[0]);
        } 
        // 如果文件输入框没有文件，尝试从预览图片获取
        else if (img && img.src && !imagePreview.classList.contains('hidden')) {
          console.log('🖼️ 从预览图片获取数据...');
          imageBase64 = img.src;
          console.log('🖼️ 预览图片数据大小:', imageBase64.length, '字符');
          // 调用真实AI分析
          callAIAnalysis(imageBase64, description);
        } 
        // 如果都没有，直接分析描述
        else {
          console.log('⚠️ 没有图片数据，直接分析描述');
          callAIAnalysis(null, description);
        }
      });
      
      // 保存记录按钮点击
      const saveRecordBtn = document.getElementById('save-record');
      saveRecordBtn.addEventListener('click', function() {
        console.log('💾 开始保存记录...');
        
        if (!appData.currentRecord) {
          console.log('❌ 没有分析结果，无法保存');
          alert('请先分析食物成分');
          return;
        }
        
        // 1. 获取描述
        const descriptionEl = document.getElementById('food-description');
        const description = descriptionEl ? descriptionEl.value.trim() : '';
        console.log('📝 描述:', description);
        
        // 2. 获取图片
        const imagePreview = document.getElementById('image-preview');
        const img = imagePreview ? imagePreview.querySelector('img') : null;
        const imageSrc = (imagePreview && !imagePreview.classList.contains('hidden') && img && img.src) ? img.src : null;
        console.log('🖼️ 图片:', imageSrc ? '有图片' : '无图片');
        console.log('🖼️ 图片详情:', {
          imagePreview: !!imagePreview,
          img: !!img,
          hidden: imagePreview ? imagePreview.classList.contains('hidden') : 'N/A',
          src: img ? img.src.substring(0, 50) + '...' : 'N/A'
        });
        
        // 3. 创建记录对象
        const record = {
          id: 'rec_' + Date.now(),
          date: new Date().toISOString().split('T')[0],
          time: new Date().toTimeString().split(' ')[0].substring(0, 5),
          description: description || '未命名食物',
          calories: appData.currentRecord.calories,
          protein: appData.currentRecord.protein,
          carbs: appData.currentRecord.carbs,
          fat: appData.currentRecord.fat,
          aiAdvice: appData.currentRecord.advice,
          image: imageSrc
        };
        
        console.log('📋 记录对象:', record);
        
        // 4. 保存到后端数据库
        console.log('🌐 开始保存到后端数据库...');
        try {
          const response = await window.apiClient.saveRecord(record);
          console.log('✅ 后端保存成功:', response);
          
          // 保存成功后添加到本地数组
          appData.foodRecords.unshift(record);
          console.log('✅ 记录已添加到本地数据数组');
          console.log('📊 当前记录总数:', appData.foodRecords.length);
          
        } catch (error) {
          console.error('❌ 后端保存失败:', error);
          alert('保存失败: ' + error.message);
          return;
        }
        
        // 5. 更新UI
        updateCalorieRecords();
        loadHistoryRecords();
        updateDailySummary();
        
        // 6. 强制刷新历史记录显示
        setTimeout(() => {
          loadHistoryRecords();
          console.log('🔄 强制刷新历史记录完成');
        }, 100);
        
        // 6. 隐藏分析结果
        const analysisResult = document.getElementById('analysis-result');
        if (analysisResult) {
          analysisResult.classList.add('hidden');
        }
        
        // 7. 重置表单
        resetCalorieForm();
        
        // 8. 显示成功提示
        alert('记录已保存！');
        console.log('🎉 保存完成');
      });
      
      // 添加记录按钮点击事件委托
      document.addEventListener('click', function(e) {
        if (e.target.closest('.add-record-btn')) {
          const recordId = e.target.closest('.add-record-btn').getAttribute('data-id');
          loadRecordToForm(recordId);
        }
      });
      
      // 取消记录按钮点击
      const cancelRecordBtn = document.getElementById('cancel-record');
      cancelRecordBtn.addEventListener('click', function() {
        // 重置表单
        resetCalorieForm();
        
        // 隐藏分析结果
        document.getElementById('analysis-result').classList.add('hidden');
      });
      
      // 日期选择器变化
      const recordDate = document.getElementById('record-date');
      recordDate.addEventListener('change', function() {
        updateCalorieRecords();
      });
      
      // 删除记录按钮点击
      document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-record')) {
          const recordId = e.target.closest('.delete-record').getAttribute('data-id');
          
          if (confirm('确定要删除这条记录吗？')) {
            // 删除记录
            appData.foodRecords = appData.foodRecords.filter(record => record.id !== recordId);
            
            // 更新每日汇总
            updateDailySummary();
            
            // 更新UI
            updateUI();
          }
        }
      });
    }

    // 更新卡路里记录
    function updateCalorieRecords() {
      console.log('🔍 [Calorie Records] 开始更新饮食记录...');
      
      const date = document.getElementById('record-date').value;
      console.log('🔍 [Calorie Records] 选择日期:', date);
      console.log('🔍 [Calorie Records] 所有记录:', appData.foodRecords);
      
      const records = appData.foodRecords.filter(record => record.date === date);
      console.log('🔍 [Calorie Records] 过滤后的记录:', records);
      
      const timeline = document.getElementById('records-timeline');
      const noRecords = document.getElementById('no-records');
      
      // 清空时间轴
      timeline.innerHTML = '';
      
      if (records.length === 0) {
        console.log('🔍 [Calorie Records] 没有找到记录，显示无记录状态');
        // 显示无记录状态
        timeline.classList.add('hidden');
        noRecords.classList.remove('hidden');
        return;
      }
      
      // 显示时间轴
      timeline.classList.remove('hidden');
      noRecords.classList.add('hidden');
      
      // 添加记录项
      records.forEach(record => {
        const recordItem = document.createElement('div');
        recordItem.className = 'history-record-item';
        
        // 构建HTML - 更小的卡片
        let recordHTML = `
          <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <div class="flex-1">
                <h3 class="text-xs font-medium text-gray-900 truncate">${record.description || '未命名食物'}</h3>
                <p class="text-xs text-gray-500">${record.time} • ${record.calories}kcal</p>
              </div>
              <div class="flex items-center space-x-1">
                <button class="text-primary hover:text-blue-700 add-record-btn" data-id="${record.id}" title="添加到表单">
                  <i class="fa fa-plus-circle text-sm"></i>
                </button>
                <button class="text-gray-400 hover:text-red-500 delete-record" data-id="${record.id}" title="删除记录">
                  <i class="fa fa-trash-o text-sm"></i>
                </button>
              </div>
            </div>
        `;
        
        // 图片显示区域 - 更小的图片
        const imageSrc = record.image || record.imageUrl; // 兼容两种字段
        if (imageSrc) {
          recordHTML += `
            <div class="mb-2">
              <img src="${imageSrc}" alt="食物图片" class="w-full h-16 object-cover rounded border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity" onclick="showImageModal('${imageSrc}')">
            </div>
          `;
        } else {
          // 没有图片时显示占位符
          recordHTML += `
            <div class="mb-2">
              <div class="w-full h-16 bg-gray-100 rounded border border-gray-200 flex items-center justify-center">
                <div class="text-center text-gray-400">
                  <i class="fa fa-camera text-lg"></i>
                </div>
              </div>
            </div>
          `;
        }
        
        recordHTML += `
          <div class="grid grid-cols-4 gap-2">
            <div class="text-center bg-gray-50 rounded p-2">
              <p class="text-xs text-gray-500">热量</p>
              <p class="text-sm font-medium text-gray-900">${record.calories}<span class="text-xs">kcal</span></p>
            </div>
            <div class="text-center bg-gray-50 rounded p-2">
              <p class="text-xs text-gray-500">蛋白质</p>
              <p class="text-sm font-medium text-gray-900">${record.protein}<span class="text-xs">g</span></p>
            </div>
            <div class="text-center bg-gray-50 rounded p-2">
              <p class="text-xs text-gray-500">碳水</p>
              <p class="text-sm font-medium text-gray-900">${record.carbs}<span class="text-xs">g</span></p>
            </div>
            <div class="text-center bg-gray-50 rounded p-2">
              <p class="text-xs text-gray-500">脂肪</p>
              <p class="text-sm font-medium text-gray-900">${record.fat}<span class="text-xs">g</span></p>
            </div>
          </div>
          <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
            <i class="fa fa-lightbulb-o mr-1"></i> ${record.aiAdvice}
          </div>
        `;
        
        recordItem.innerHTML = recordHTML;
        timeline.appendChild(recordItem);
      });
      
      // 更新历史记录快捷选择
      loadHistoryRecords();
    }
    
    // 加载历史记录到快捷选择
    async function loadHistoryRecords() {
      const historyContainer = document.getElementById('history-records');
      
      console.log('🔍 [History] 开始加载历史记录...');
      
      // 从后端加载数据
      try {
        console.log('🌐 从后端加载历史记录...');
        const response = await window.apiClient.getRecords();
        console.log('✅ 后端数据加载成功:', response);
        
        if (response.success && response.data) {
          appData.foodRecords = response.data;
          console.log('📊 更新本地数据，记录数量:', appData.foodRecords.length);
        }
      } catch (error) {
        console.error('❌ 后端数据加载失败:', error);
        // 如果后端加载失败，使用本地数据
        console.log('⚠️ 使用本地数据作为备选');
      }
      
      console.log('🔍 [History] appData.foodRecords:', appData.foodRecords);
      console.log('🔍 [History] 记录数量:', appData.foodRecords ? appData.foodRecords.length : 0);
      
      // 如果没有记录，显示提示
      if (!appData.foodRecords || appData.foodRecords.length === 0) {
        console.log('ℹ️ 没有历史记录');
        historyContainer.innerHTML = `
          <div class="text-center text-gray-500 py-4">
            暂无历史记录
          </div>
        `;
        return;
      }
      
      // 统计记录频率
      const recordFrequency = {};
      appData.foodRecords.forEach(record => {
        if (!recordFrequency[record.description]) {
          recordFrequency[record.description] = {
            count: 0,
            record: record
          };
        }
        recordFrequency[record.description].count++;
      });
      
      // 转换为数组并按频率排序
      const sortedRecords = Object.values(recordFrequency)
        .sort((a, b) => b.count - a.count)
        .slice(0, 6); // 取前6个最频繁的记录
      
      // 清空容器
      historyContainer.innerHTML = '';
      
      // 添加记录项
      sortedRecords.forEach(item => {
        const record = item.record;
        const historyItem = document.createElement('div');
        historyItem.className = 'history-record-item bg-gray-50 rounded-lg p-3 flex flex-col items-center cursor-pointer hover:bg-gray-100 transition-all-300';
        historyItem.setAttribute('data-id', record.id);
        
        let itemHTML = '';
        
        // 如果有图片，显示图片
        if (record.image) {
          itemHTML += `
            <img src="${record.image}" alt="食物图片" class="w-full h-16 object-cover rounded-lg mb-2">
          `;
        } else {
          // 使用默认图标
          itemHTML += `
            <div class="w-full h-16 bg-gray-200 rounded-lg mb-2 flex items-center justify-center">
              <i class="fa fa-cutlery text-gray-400 text-2xl"></i>
            </div>
          `;
        }
        
        itemHTML += `
          <p class="text-xs text-center truncate w-full">${record.description}</p>
          <p class="text-xs text-gray-500 mt-1">${record.calories} kcal</p>
        `;
        
        historyItem.innerHTML = itemHTML;
        historyContainer.appendChild(historyItem);
      });
    }
    
    // 加载记录到表单
    function loadRecordToForm(recordId) {
      console.log('🔄 加载记录到表单:', recordId);
      
      const record = appData.foodRecords.find(r => r.id === recordId);
      if (!record) {
        console.log('❌ 找不到记录:', recordId);
        return;
      }
      
      console.log('✅ 找到记录:', record);
      
      // 填充描述
      const foodDescEl = document.getElementById('food-description');
      if (foodDescEl) {
        foodDescEl.value = record.description || '未命名食物';
        console.log('✅ 已填充描述:', record.description);
      }
      
      // 如果有图片，显示图片
      const imageSrc = record.image || record.imageUrl; // 兼容两种字段
      if (imageSrc) {
        console.log('🖼️ 加载图片数据:', imageSrc ? '有图片' : '无图片');
        
        const imagePreview = document.getElementById('image-preview');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const img = imagePreview ? imagePreview.querySelector('img') : null;
        
        if (img && imageSrc) {
          img.src = imageSrc;
          imagePreview.classList.remove('hidden');
          uploadPlaceholder.classList.add('hidden');
          console.log('✅ 图片已显示');
          
          // 同时设置文件输入框（模拟文件选择）
          const foodImage = document.getElementById('food-image');
          if (foodImage) {
            // 创建一个虚拟文件对象
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const tempImg = new Image();
            
            tempImg.onload = function() {
              canvas.width = tempImg.width;
              canvas.height = tempImg.height;
              ctx.drawImage(tempImg, 0, 0);
              
              canvas.toBlob(function(blob) {
                const file = new File([blob], 'loaded-image.jpg', { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                foodImage.files = dataTransfer.files;
                console.log('✅ 文件输入框已设置');
              }, 'image/jpeg');
            };
            
            tempImg.src = imageSrc;
          }
        }
      } else {
        console.log('ℹ️ 该记录没有图片');
        // 隐藏图片预览
        const imagePreview = document.getElementById('image-preview');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        if (imagePreview && uploadPlaceholder) {
          imagePreview.classList.add('hidden');
          uploadPlaceholder.classList.remove('hidden');
        }
        
        // 清空文件输入框
        const foodImage = document.getElementById('food-image');
        if (foodImage) {
          foodImage.value = '';
        }
      }
      
      // 滚动到分析按钮
      const analyzeBtn = document.getElementById('analyze-btn');
      if (analyzeBtn) {
        analyzeBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      console.log('✅ 记录加载完成');
      
      // 显示提示
      alert('已加载历史记录，请点击"分析营养成分"按钮确认');
    }

    // 重置卡路里表单
    function resetCalorieForm() {
      document.getElementById('food-image').value = '';
      document.getElementById('food-description').value = '';
      document.getElementById('image-preview').classList.add('hidden');
      document.getElementById('upload-placeholder').classList.remove('hidden');
      document.getElementById('image-preview').querySelector('img').src = '';
    }
    
    // 显示图片模态框
    function showImageModal(imageSrc) {
      console.log('🖼️ 显示图片模态框:', imageSrc.substring(0, 50) + '...');
      
      // 创建模态框
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
      modal.onclick = function(e) {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      };
      
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-4 max-w-4xl max-h-4xl relative">
          <button class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl" onclick="document.body.removeChild(this.closest('.fixed'))">
            <i class="fa fa-times"></i>
          </button>
          <img src="${imageSrc}" alt="食物图片" class="max-w-full max-h-96 object-contain rounded">
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // 显示分析结果
    function showAnalysisResult(result) {
      // 保存当前记录
      appData.currentRecord = result;
      
      // 更新结果时间
      const now = new Date();
      const timeString = now.toTimeString().split(' ')[0].substring(0, 5);
      const dateString = now.toISOString().split('T')[0];
      const resultTimeEl = document.getElementById('result-time');
      if (resultTimeEl) {
        resultTimeEl.textContent = `${dateString} ${timeString}`;
      }
      
      // 更新营养数据
      const resultCaloriesEl = document.getElementById('result-calories');
      const resultProteinEl = document.getElementById('result-protein');
      const resultMacrosEl = document.getElementById('result-macros');
      const resultAdviceEl = document.getElementById('result-advice');
      
      if (resultCaloriesEl) {
        resultCaloriesEl.innerHTML = `${result.calories}<span class="text-sm font-normal text-gray-500">kcal</span>`;
      }
      if (resultProteinEl) {
        resultProteinEl.innerHTML = `${result.protein}<span class="text-sm font-normal text-gray-500">g</span>`;
      }
      if (resultMacrosEl) {
        resultMacrosEl.innerHTML = `${result.carbs}/${result.fat}<span class="text-sm font-normal text-gray-500">g</span>`;
      }
      if (resultAdviceEl) {
        resultAdviceEl.textContent = result.advice;
      }
      
      // 显示结果
      document.getElementById('analysis-result').classList.remove('hidden');
      
      // 滚动到结果
      document.getElementById('analysis-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 初始化设置页面
    function initSettings() {
      // 体重目标滑块
      const weightGoalInput = document.getElementById('weight-goal-input');
      const weightGoalValue = document.getElementById('weight-goal-value');
      
      weightGoalInput.addEventListener('input', function() {
        weightGoalValue.textContent = parseFloat(this.value).toFixed(1);
      });
      
      // 保存目标按钮点击
      const saveGoalBtn = document.getElementById('save-goal');
      saveGoalBtn.addEventListener('click', function() {
        const goal = parseFloat(weightGoalInput.value) * 1000; // 转换为克
        appData.userProfile.weightGoal = goal;
        
        // 更新UI
        updateUI();
        
        // 显示成功提示
        alert('目标已保存');
      });
      

      
      // 立即同步按钮点击
      const syncGarminBtn = document.getElementById('sync-garmin');
      syncGarminBtn.addEventListener('click', function() {
        // 显示加载弹窗
        showLoadingModal('正在同步Garmin数据...');
        
        // 模拟同步延迟
        setTimeout(function() {
          // 模拟同步结果
          const garminData = simulateGarminData();
          
          // 更新最后同步时间
          appData.userProfile.lastSync = new Date().toISOString();
          
          // 更新每日汇总
          updateDailySummary(garminData);
          
          // 更新UI
          updateUI();
          
          // 隐藏加载弹窗
          hideLoadingModal();
          
          // 显示成功提示
          alert('同步成功');
        }, 2000);
      });
      

    }

    // 更新设置页面
    function updateSettings() {
      // 更新体重目标
      const weightGoal = appData.userProfile.weightGoal / 1000; // 转换为千克
      document.getElementById('weight-goal-input').value = weightGoal;
      document.getElementById('weight-goal-value').textContent = weightGoal.toFixed(1);
      
      // 更新Garmin状态
      const garminStatus = document.getElementById('garmin-status');
      
      garminStatus.textContent = appData.userProfile.garminConnected ? '已连接' : '未连接';
      garminStatus.className = appData.userProfile.garminConnected ? 'text-sm text-green-600' : 'text-sm text-red-600';
      
      // 更新最后同步时间
      if (appData.userProfile.lastSync) {
        const date = new Date(appData.userProfile.lastSync);
        const dateString = date.toISOString().split('T')[0];
        const timeString = date.toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('last-sync-time').textContent = `${dateString} ${timeString}`;
      } else {
        document.getElementById('last-sync-time').textContent = '从未同步';
      }
    }

    // 初始化模态框
    function initModals() {
      // 这里可以添加初始化模态框的逻辑
    }
    

    
    // 为底部导航栏添加点击事件委托 - 增强版
    document.querySelector('nav').addEventListener('click', function(e) {
      console.log('导航栏被点击:', e.target);
      const tab = e.target.closest('.nav-tab');
      if (tab) {
        console.log('导航按钮被点击:', tab.getAttribute('data-tab'));
        // 直接调用切换函数
        switchTab(tab.getAttribute('data-tab'));
        // 阻止事件冒泡
        e.stopPropagation();
      }
    });
    
    // 添加全局点击事件监听，查看是否有其他元素阻止了事件
    // 注释掉全局监听器，避免干扰其他点击事件
    // document.addEventListener('click', function(e) {
    //   console.log('全局点击:', e.target);
    // }, true);

    // 显示加载弹窗
    function showLoadingModal(text) {
      const loadingModal = document.getElementById('loading-modal');
      const loadingText = document.getElementById('loading-text');
      
      if (!loadingModal || !loadingText) {
        console.warn('[Loading] 加载弹窗元素未找到');
        return;
      }
      
      if (text) {
        loadingText.textContent = text;
      }
      
      loadingModal.classList.remove('hidden');
    }

    // 隐藏加载弹窗
    function hideLoadingModal() {
      const loadingModal = document.getElementById('loading-modal');
      if (!loadingModal) {
        console.warn('[Loading] 加载弹窗元素未找到');
        return;
      }
      loadingModal.classList.add('hidden');
    }

    // 更新每日汇总
    function updateDailySummary(garminData) {
      const today = new Date().toISOString().split('T')[0];
      const todayRecords = appData.foodRecords.filter(record => record.date === today);
      
      // 计算总摄入
      let totalCaloriesIn = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      
      todayRecords.forEach(record => {
        totalCaloriesIn += record.calories;
        totalProtein += record.protein;
        totalCarbs += record.carbs;
        totalFat += record.fat;
      });
      
      // 获取消耗数据
      let totalCaloriesOut = 2000; // 默认基础代谢
      let trainingType = 'none';
      
      if (garminData) {
        totalCaloriesOut = garminData.totalCalories;
        trainingType = garminData.trainingType;
      } else {
        // 检查是否有Garmin数据
        const garminData = simulateGarminData(); // 模拟数据
        totalCaloriesOut = garminData.totalCalories;
        trainingType = garminData.trainingType;
      }
      
      // 计算脂肪变化
      const fatChangeResult = estimate_fat_change(totalCaloriesIn, totalCaloriesOut, trainingType);
      
      // 更新每日汇总
      const summaryIndex = appData.dailySummaries.findIndex(s => s.date === today);
      
      if (summaryIndex !== -1) {
        // 更新现有汇总
        appData.dailySummaries[summaryIndex] = {
          date: today,
          totalCaloriesIn,
          totalProtein,
          totalCarbs,
          totalFat,
          totalCaloriesOut,
          trainingType,
          fatChange: fatChangeResult.fat_change_g
        };
      } else {
        // 添加新汇总
        appData.dailySummaries.push({
          date: today,
          totalCaloriesIn,
          totalProtein,
          totalCarbs,
          totalFat,
          totalCaloriesOut,
          trainingType,
          fatChange: fatChangeResult.fat_change_g
        });
      }
      
      // 更新当前减脂量
      if (summaryIndex !== -1) {
        const previousFatChange = appData.dailySummaries[summaryIndex].fatChange;
        appData.userProfile.currentWeightLoss = Math.max(0, appData.userProfile.currentWeightLoss - previousFatChange + fatChangeResult.fat_change_g);
      } else {
        appData.userProfile.currentWeightLoss += Math.abs(fatChangeResult.fat_change_g);
      }
    }

    // 模拟AI分析
    function simulateAIAnalysis(imageUrl, description) {
      // 这里使用预设的食物数据库模拟AI分析
      const foodDatabase = [
        { keywords: ["炸鸡", "鸡排"], calories: 300, protein: 25, carbs: 10, fat: 18 },
        { keywords: ["米饭", "白饭"], calories: 150, protein: 3, carbs: 35, fat: 0.5 },
        { keywords: ["蔬菜", "青菜"], calories: 50, protein: 3, carbs: 10, fat: 0.5 },
        { keywords: ["牛肉", "牛排"], calories: 250, protein: 25, carbs: 0, fat: 18 },
        { keywords: ["沙拉", "蔬菜沙拉"], calories: 100, protein: 5, carbs: 15, fat: 3 },
        { keywords: ["面包", "吐司"], calories: 120, protein: 4, carbs: 25, fat: 1.5 },
        { keywords: ["鸡蛋", "蛋"], calories: 70, protein: 6, carbs: 0, fat: 5 },
        { keywords: ["牛奶"], calories: 100, protein: 8, carbs: 12, fat: 3 },
        { keywords: ["鸡胸肉"], calories: 165, protein: 31, carbs: 0, fat: 3.6 },
        { keywords: ["水果", "水果沙拉"], calories: 80, protein: 1, carbs: 20, fat: 0 },
        { keywords: ["健身餐"], calories: 450, protein: 40, carbs: 30, fat: 15 }
      ];
      
      let calories = 0;
      let protein = 0;
      let carbs = 0;
      let fat = 0;
      
      // 简单的关键词匹配
      if (description) {
        foodDatabase.forEach(food => {
          food.keywords.forEach(keyword => {
            if (description.includes(keyword)) {
              calories += food.calories;
              protein += food.protein;
              carbs += food.carbs;
              fat += food.fat;
            }
          });
        });
      }
      
      // 如果没有匹配到食物，说明AI分析失败
      if (calories === 0) {
        console.error('❌ AI分析失败，未获取到有效结果');
        console.error('❌ 请检查AI API是否正确调用');
        throw new Error('AI分析失败，请检查网络连接和API配置');
      }
      
      // 生成AI建议
      const adviceOptions = [
        "今天的饮食搭配不错，继续保持！",
        "下午可以增加一些有氧运动，帮助消耗多余热量。",
        "建议增加蛋白质摄入，有助于肌肉维持。",
        "注意控制碳水化合物的摄入，选择更健康的碳水来源。",
        "多喝水，保持身体水分充足。",
        "晚餐可以适当减少份量，有助于夜间消化。"
      ];
      
      const advice = adviceOptions[Math.floor(Math.random() * adviceOptions.length)];
      
      return {
        calories,
        protein,
        carbs,
        fat,
        advice
      };
    }

    // 模拟Garmin数据
    function simulateGarminData() {
      // 模拟Garmin数据
      const trainingTypes = ["none", "A", "S", "both"];
      const randomType = trainingTypes[Math.floor(Math.random() * trainingTypes.length)];
      
      // 基础代谢率 + 活动消耗
      const baseMetabolism = 1800; // 基础代谢率
      const activityLevel = Math.random(); // 0-1之间的活动水平
      
      let activityCalories = 0;
      if (randomType === "A") {
        activityCalories = 300 + Math.random() * 200; // 有氧消耗300-500
      } else if (randomType === "S") {
        activityCalories = 200 + Math.random() * 150; // 无氧消耗200-350
      } else if (randomType === "both") {
        activityCalories = 400 + Math.random() * 300; // 混合消耗400-700
      } else {
        activityCalories = 50 + Math.random() * 150; // 日常活动消耗50-200
      }
      
      const totalCalories = baseMetabolism + activityCalories;
      
      return {
        connected: true,
        lastSync: new Date().toISOString(),
        totalCalories,
        trainingType: randomType,
        steps: Math.floor(5000 + Math.random() * 10000), // 5000-15000步
        heartRate: {
          average: 65 + Math.floor(Math.random() * 20),
          max: 120 + Math.floor(Math.random() * 50)
        }
      };
    }

    // 脂肪变化估算算法
    function estimate_fat_change(cal_in, cal_out, training_type) {
      const D = cal_in - cal_out; // 热量差，正值=盈余，负值=赤字

      // === 情况1：赤字（减脂） ===
      if (D < 0) {
        const D_abs = Math.abs(D);
        // 赤字区间基础系数
        let f_base;
        if (D_abs <= 700) {
          f_base = 0.60;
        } else if (D_abs <= 900) {
          f_base = 0.55;
        } else {
          f_base = 0.45;
        }

        // 训练修正（赤字时）
        const t_adj = {"none": 0.00, "A": 0.08, "S": 0.10, "both": 0.18};
        const f_ratio = f_base + (t_adj[training_type] || 0.00);

        const fat_change = -D_abs * f_ratio / 9; // kcal 转 g脂肪，1g脂肪约9 kcal

        return {
          "D": D_abs,
          "mode": "deficit",
          "ratio": f_ratio,
          "fat_change_g": fat_change
        };
      }

      // === 情况2：盈余（增脂） ===
      else {
        if (D <= 400) {
          s_base = 0.50;
        } else if (D <= 800) {
          s_base = 0.65;
        } else {
          s_base = 0.80;
        }

        // 训练修正（盈余时）
        const t_adj = {"none": 0.00, "A": -0.05, "S": -0.15, "both": -0.20};
        const s_ratio = s_base + (t_adj[training_type] || 0.00);

        const fat_change = D * s_ratio / 9;

        return {
          "D": D,
          "mode": "surplus",
          "ratio": s_ratio,
          "fat_change_g": fat_change
        };
      }
    }
  </script>


</body></html>