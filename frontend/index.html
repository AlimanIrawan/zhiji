<html lang="zh-CN"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è„‚è®° - å‡è„‚è¿›åº¦è¿½è¸ªåº”ç”¨</title>
  <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æœ¬åœ°Tailwind CSS -->
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <!-- APIé…ç½® -->
  <script src="config.js"></script>
  <script src="api.js"></script>
  <script defer src="api-integration.js"></script>
  <!-- ç»Ÿä¸€çš„ Tailwind é…ç½® -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6', // è“è‰²
            secondary: '#10b981', // ç»¿è‰²
            tertiary: '#f59e0b', // æ©™è‰²ï¼ˆç”¨äºè¿˜éœ€åŠªåŠ›å¤©æ•°ï¼‰
            accent: '#f59e0b', // æ©™è‰²
            light: '#f3f4f6',
            dark: '#1f2937'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
    }
  </style>
  <style>
    /* è‡ªå®šä¹‰æ ·å¼ */
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: #f9fafb;
      padding-bottom: 60px; /* ä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .progress-ring-circle {
      transition: stroke-dashoffset 0.35s;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
    
    .timeline-item {
      position: relative;
      padding-left: 28px;
      margin-bottom: 16px;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #3b82f6;
    }
    
    .timeline-item::after {
      content: '';
      position: absolute;
      left: 7px;
      top: 16px;
      width: 2px;
      height: calc(100% + 8px);
      background-color: #e5e7eb;
    }
    
    .timeline-item:last-child::after {
      display: none;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .calendar-day.has-data::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 4px;
      height: 4px;
      border-radius: 50%;
    }
    
    .calendar-day.loss::after {
      background-color: #10b981;
    }
    
    .calendar-day.gain::after {
      background-color: #ef4444;
    }
    
    .food-item {
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
    .food-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .nav-tab {
      transition: all 0.3s ease;
    }
    
    .nav-tab.active {
      color: #3b82f6;
    }
    
    .nav-tab.active i {
      transform: scale(1.2);
    }
    
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out forwards;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* å¡ç‰‡æ‚¬æµ®æ•ˆæœ */
    .hover-card {
      transition: all 0.3s ease;
    }
    
    .hover-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 640px) {
      .mobile-flex-row {
        flex-direction: row !important;
      }
      .mobile-no-mb {
        margin-bottom: 0 !important;
      }
      .mobile-w-24 {
        width: 6rem !important;
        height: 6rem !important;
      }
      .mobile-text-xl {
        font-size: 1.25rem !important;
      }
      .mobile-text-sm {
        font-size: 0.75rem !important;
      }
      .mobile-p-2 {
        padding: 0.5rem !important;
      }
      .mobile-gap-2 {
        gap: 0.5rem !important;
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0f9f48a12fe34000bbe06bf2649ebbef~tplv-a9rns2rl98-image.image?rcl=20251019014617F030EFD8943FDD0B1D0C&amp;rk3s=8e244e95&amp;rrcfp=f06b921b&amp;x-expires=1763401621&amp;x-signature=p0u6OqeaxitEpc%2B3Scy5r560pVY%3D" alt="è„‚è®°Logo" class="h-8 w-8">
        <h1 class="text-xl font-bold text-primary">è„‚è®°</h1>
      </div>

    </div>
  </header>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
    <section id="dashboard-tab" class="tab-content">
      <!-- å‡è„‚è¿›åº¦å¡ç‰‡ - ç§»åŠ¨ç«¯ä¼˜åŒ– -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6 hover-card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">å‡è„‚è¿›åº¦</h2>
        
        <!-- å®Œæˆåº¦æ˜¾ç¤º - åŒ…å«ç¯å½¢è¿›åº¦æ¡ -->
        <div class="flex flex-col items-center justify-center mb-6">
          <div class="relative w-48 h-48 mb-4">
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50"></circle>
              <circle id="progress-circle" class="text-primary progress-ring-circle" stroke-width="10" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" stroke-dasharray="251.2" stroke-dashoffset="75.36"></circle>
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span id="progress-percentage" class="text-5xl font-bold text-primary">75%</span>
              <span class="text-xl text-gray-500">å®Œæˆåº¦</span>
            </div>
          </div>
        </div>
        
        <div class="flex flex-col md:flex-row items-center justify-between mobile-flex-row">
          <div class="w-full md:w-2/3 grid grid-cols-2 md:grid-cols-3 gap-4 mobile-gap-2">
            <div class="bg-gray-50 rounded-lg p-4 text-center mobile-p-2">
              <p class="text-sm text-gray-500 mb-1 mobile-text-sm">ç›®æ ‡å‡è„‚</p>
              <p id="weight-goal" class="text-xl font-bold mobile-text-xl">5.0<span class="text-sm font-normal text-gray-500 mobile-text-sm">kg</span></p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center mobile-p-2">
              <p class="text-sm text-gray-500 mb-1 mobile-text-sm">å·²å‡è„‚</p>
              <p id="current-loss" class="text-xl font-bold text-secondary mobile-text-xl">3.75<span class="text-sm font-normal text-gray-500 mobile-text-sm">kg</span></p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center mobile-p-2">
              <p class="text-sm text-gray-500 mb-1 mobile-text-sm">è¿˜éœ€åŠªåŠ›</p>
              <p id="remaining-days" class="text-xl font-bold text-tertiary mobile-text-xl">7<span class="text-sm font-normal text-gray-500 mobile-text-sm">å¤©</span></p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center mobile-p-2 col-span-1 md:col-span-3">
              <p class="text-sm text-gray-500 mb-1 mobile-text-sm">å·²è®°å½•å¤©æ•°</p>
              <p id="recorded-days" class="text-xl font-bold mobile-text-xl">21<span class="text-sm font-normal text-gray-500 mobile-text-sm">å¤©</span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- ä»Šæ—¥æ•°æ®å¡ç‰‡ -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6 hover-card">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">ä»Šæ—¥æ•°æ®</h2>
        <div>
          <!-- ä»Šæ—¥è„‚è‚ªå˜åŒ– -->
          <div class="bg-gray-50 rounded-xl p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between">
              <div>
                <h3 class="text-md font-medium text-gray-600">ä»Šæ—¥è„‚è‚ªå˜åŒ–</h3>
                <span class="text-sm text-gray-500 flex items-center mt-1">
                  <i id="fat-change-icon" class="fa fa-arrow-down text-green-600 mr-1"></i> 
                  <span id="fat-change-status">å‡è„‚ä¸­</span>
                </span>
              </div>
              <div class="flex items-start justify-end pt-1">
                <span id="fat-change" class="text-3xl font-bold text-green-600">+0.00g</span>
              </div>
            </div>
          </div>
          
          <!-- çƒ­é‡æ”¶æ”¯ -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-md font-medium text-gray-600">çƒ­é‡æ”¶æ”¯</h3>
              <span id="calorie-balance" class="text-sm font-medium px-2 py-1 rounded-full bg-green-100 text-green-800">
                <i class="fa fa-arrow-down mr-1"></i>500 kcal
              </span>
            </div>
            
            <!-- æ‘„å…¥ä¸æ¶ˆè€—å¯¹æ¯” -->
            <div class="relative h-16 bg-gray-200 rounded-full overflow-hidden mb-4">
              <div class="absolute top-0 left-0 h-full bg-red-500 flex items-center justify-end pr-4" id="calories-in-bar" style="width: 44%">
                <span id="calories-in" class="text-white font-medium">1800 kcal</span>
              </div>
              <div class="absolute top-0 right-0 h-full bg-green-500 flex items-center justify-start pl-4" id="calories-out-bar" style="width: 56%">
                <span id="calories-out" class="text-white font-medium">2300 kcal</span>
              </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-xs text-gray-500 mb-1">è›‹ç™½è´¨</p>
                <p id="protein" class="text-sm font-medium">120<span class="text-xs text-gray-500">g</span></p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-xs text-gray-500 mb-1">ç¢³æ°´</p>
                <p id="carbs" class="text-sm font-medium">150<span class="text-xs text-gray-500">g</span></p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-xs text-gray-500 mb-1">è„‚è‚ª</p>
                <p id="fat" class="text-sm font-medium">65<span class="text-xs text-gray-500">g</span></p>
              </div>
            </div>
          </div>
          
          <!-- ä»Šæ—¥è®­ç»ƒ -->
          <div>
            <h3 class="text-md font-medium text-gray-600 mb-4">ä»Šæ—¥è®­ç»ƒ</h3>
            <div class="bg-gray-50 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                    <i class="fa fa-running text-primary"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium">æœ‰æ°§è¿åŠ¨</p>
                    <p class="text-xs text-gray-500">30åˆ†é’Ÿ</p>
                  </div>
                </div>
                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                  <i class="fa fa-check text-secondary"></i>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center mr-3">
                    <i class="fa fa-dumbbell text-accent"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium">åŠ›é‡è®­ç»ƒ</p>
                    <p class="text-xs text-gray-500">45åˆ†é’Ÿ</p>
                  </div>
                </div>
                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                  <i class="fa fa-check text-secondary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æœˆæ—¥å†è§†å›¾ -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6 hover-card">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-700">æ—¥è„‚è‚ªå˜åŒ–</h2>
          <div class="flex space-x-2">
            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100 transition-all-300">
              <i class="fa fa-chevron-left text-gray-500"></i>
            </button>
            <span id="current-month" class="text-sm font-medium">2025å¹´7æœˆ</span>
            <button id="next-month" class="p-2 rounded-full hover:bg-gray-100 transition-all-300">
              <i class="fa fa-chevron-right text-gray-500"></i>
            </button>
          </div>
        </div>
        
        <!-- æ˜ŸæœŸæ ‡é¢˜ -->
        <div class="grid grid-cols-7 gap-1 mb-2">
          <div class="text-center text-xs text-gray-500">æ—¥</div>
          <div class="text-center text-xs text-gray-500">ä¸€</div>
          <div class="text-center text-xs text-gray-500">äºŒ</div>
          <div class="text-center text-xs text-gray-500">ä¸‰</div>
          <div class="text-center text-xs text-gray-500">å››</div>
          <div class="text-center text-xs text-gray-500">äº”</div>
          <div class="text-center text-xs text-gray-500">å…­</div>
        </div>
        
        <!-- æ—¥å†ç½‘æ ¼ -->
        <div id="calendar-grid" class="grid grid-cols-7 gap-1">
          <!-- æ—¥å†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="mt-4 flex items-center justify-center space-x-6">
          <div class="flex items-center">
            <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
            <span class="text-xs text-gray-500">å‡è„‚</span>
          </div>
          <div class="flex items-center">
            <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
            <span class="text-xs text-gray-500">å¢è„‚</span>
          </div>
        </div>
      </div>


    </section>

    <!-- å¡è·¯é‡Œæ‘„å…¥è®°å½•é¡µé¢ -->
    <section id="calorie-tab" class="tab-content active">
      <!-- è®°å½•è¡¨å• -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">æ·»åŠ é¥®é£Ÿè®°å½•</h2>
        
        <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">ä¸Šä¼ é£Ÿç‰©å›¾ç‰‡</label>
          <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-all-300 cursor-pointer">
            <input type="file" id="food-image" class="hidden" accept="image/*" style="position: absolute; left: -9999px; opacity: 0;">
            <div id="image-preview" class="hidden mb-4">
              <img src="" alt="é£Ÿç‰©é¢„è§ˆ" class="max-h-40 mx-auto rounded-lg">
            </div>
            <div id="upload-placeholder">
              <i class="fa fa-camera text-gray-400 text-3xl mb-2"></i>
              <p class="text-sm text-gray-500">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹ç…§</p>
              <p class="text-xs text-gray-400 mt-1">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
            </div>
          </div>
        </div>
        
        <!-- é£Ÿç‰©æè¿° -->
        <div class="mb-6">
          <label for="food-description" class="block text-sm font-medium text-gray-700 mb-2">é£Ÿç‰©æè¿°</label>
          <textarea id="food-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all-300" placeholder="ä¾‹å¦‚ï¼šåˆé¤ï¼šç‚¸é¸¡æ’ã€ç±³é¥­ã€è”¬èœ"></textarea>
        </div>
        
        <!-- å†å²è®°å½•å¿«æ·é€‰æ‹© -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <p class="text-sm font-medium text-gray-700">å†å²è®°å½•</p>
            <span class="text-xs text-gray-500">ç‚¹å‡»å¿«é€Ÿæ·»åŠ </span>
          </div>
          <div id="history-records" class="space-y-3 max-h-96 overflow-y-auto">
            <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            <div class="text-center text-gray-500 py-4">
              æš‚æ— å†å²è®°å½•
            </div>
          </div>
        </div>
        
        <!-- æäº¤æŒ‰é’® -->
        <button id="analyze-btn" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-all-300 flex items-center justify-center">
          <i class="fa fa-search-plus mr-2"></i>
          åˆ†æè¥å…»æˆåˆ†
        </button>
      </div>
      
      <!-- åˆ†æç»“æœ -->
      <div id="analysis-result" class="bg-white rounded-xl shadow-md p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-700">åˆ†æç»“æœ</h2>
          <span id="result-time" class="text-xs text-gray-500">2025-07-21 12:30</span>
        </div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">æ€»çƒ­é‡</p>
            <p id="result-calories" class="text-xl font-bold text-primary">650<span class="text-sm font-normal text-gray-500">kcal</span></p>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">è›‹ç™½è´¨</p>
            <p id="result-protein" class="text-xl font-bold text-secondary">35<span class="text-sm font-normal text-gray-500">g</span></p>
          </div>
          <div class="bg-orange-50 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">ç¢³æ°´/è„‚è‚ª</p>
            <p id="result-macros" class="text-xl font-bold text-accent">50/30<span class="text-sm font-normal text-gray-500">g</span></p>
          </div>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <h3 class="text-sm font-medium text-gray-700 mb-2">AI å»ºè®®</h3>
          <p id="result-advice" class="text-sm text-gray-600">
            ä¸‹åˆå¯ä»¥å¢åŠ ä¸€äº›æœ‰æ°§è¿åŠ¨ï¼Œå¸®åŠ©æ¶ˆè€—å¤šä½™çƒ­é‡ã€‚
          </p>
        </div>
        
        <div class="flex space-x-3">
          <button id="save-record" class="flex-1 bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
            ä¿å­˜è®°å½•
          </button>
          <button id="cancel-record" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all-300">
            å–æ¶ˆ
          </button>
        </div>
      </div>
      
      <!-- é¥®é£Ÿè®°å½•æ—¶é—´è½´ -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-700">é¥®é£Ÿè®°å½•</h2>
          <div class="relative">
            <input type="date" id="record-date" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-primary focus:border-primary">
          </div>
        </div>
        
        <div id="records-timeline" class="space-y-4">
          <!-- è®°å½•é¡¹ 1 -->
          <div class="timeline-item bg-gray-50 rounded-lg p-4 relative">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500 delete-record" data-id="1">
              <i class="fa fa-trash-o"></i>
            </button>
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-sm font-medium">åˆé¤ï¼šç‚¸é¸¡æ’ã€ç±³é¥­ã€è”¬èœ</h3>
              <span class="text-xs text-gray-500">12:30</span>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-2">
              <div class="text-center">
                <p class="text-xs text-gray-500">çƒ­é‡</p>
                <p class="text-sm font-medium">650<span class="text-xs">kcal</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">è›‹ç™½è´¨</p>
                <p class="text-sm font-medium">35<span class="text-xs">g</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">ç¢³æ°´</p>
                <p class="text-sm font-medium">50<span class="text-xs">g</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">è„‚è‚ª</p>
                <p class="text-sm font-medium">30<span class="text-xs">g</span></p>
              </div>
            </div>
            <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
              <i class="fa fa-lightbulb-o mr-1"></i> ä¸‹åˆå¯ä»¥å¢åŠ ä¸€äº›æœ‰æ°§è¿åŠ¨ï¼Œå¸®åŠ©æ¶ˆè€—å¤šä½™çƒ­é‡ã€‚
            </div>
          </div>
          
          <!-- è®°å½•é¡¹ 2 -->
          <div class="timeline-item bg-gray-50 rounded-lg p-4 relative">
            <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500 delete-record" data-id="2">
              <i class="fa fa-trash-o"></i>
            </button>
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-sm font-medium">æ—©é¤ï¼šå…¨éº¦é¢åŒ…ã€é¸¡è›‹ã€ç‰›å¥¶</h3>
              <span class="text-xs text-gray-500">08:00</span>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-2">
              <div class="text-center">
                <p class="text-xs text-gray-500">çƒ­é‡</p>
                <p class="text-sm font-medium">350<span class="text-xs">kcal</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">è›‹ç™½è´¨</p>
                <p class="text-sm font-medium">20<span class="text-xs">g</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">ç¢³æ°´</p>
                <p class="text-sm font-medium">40<span class="text-xs">g</span></p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500">è„‚è‚ª</p>
                <p class="text-sm font-medium">12<span class="text-xs">g</span></p>
              </div>
            </div>
            <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
              <i class="fa fa-lightbulb-o mr-1"></i> æ—©é¤æ­é…å‡è¡¡ï¼Œè›‹ç™½è´¨å……è¶³ï¼Œæœ‰åŠ©äºè‚Œè‚‰ç»´æŒã€‚
            </div>
          </div>
        </div>
        
        <!-- æ— è®°å½•çŠ¶æ€ -->
        <div id="no-records" class="hidden text-center py-8">
          <i class="fa fa-utensils text-gray-300 text-4xl mb-3"></i>
          <p class="text-gray-500">ä»Šå¤©è¿˜æ²¡æœ‰é¥®é£Ÿè®°å½•</p>
          <p class="text-xs text-gray-400 mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ è®°å½•</p>
        </div>
      </div>
    </section>

    <!-- è®¾ç½®é¡µé¢ -->
    <section id="settings-tab" class="tab-content">
      <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div class="flex items-center justify-center py-4">
          <div class="text-center">
            <p class="text-sm text-gray-500 mb-1">å¼€å§‹å‡è„‚</p>
            <p class="text-xl font-semibold">2025-07-01</p>
          </div>
        </div>
      </div>
      
      <!-- å‡è„‚ç›®æ ‡è®¾ç½® -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">å‡è„‚ç›®æ ‡</h2>
        <div class="mb-4">
          <label for="weight-goal-input" class="block text-sm font-medium text-gray-700 mb-2">ç›®æ ‡å‡è„‚é‡é‡ (kg)</label>
          <div class="flex items-center">
            <input type="range" id="weight-goal-input" min="1" max="10" step="0.5" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            <span id="weight-goal-value" class="ml-3 text-sm font-medium min-w-[3rem] text-center">5.0</span>
          </div>
        </div>
        <button id="save-goal" class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300">
          ä¿å­˜ç›®æ ‡
        </button>
      </div>
      
      <!-- Garmin è¿æ¥çŠ¶æ€ -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Garmin è¿æ¥</h2>
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-sm font-medium">è¿æ¥çŠ¶æ€</p>
            <p id="garmin-status" class="text-sm text-green-600">å·²è¿æ¥</p>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between mb-2">
            <p class="text-sm text-gray-500">æœ€ååŒæ­¥æ—¶é—´</p>
            <p id="last-sync-time" class="text-sm font-medium">2025-07-21 08:30</p>
          </div>
          <div class="flex justify-between">
            <p class="text-sm text-gray-500">åŒæ­¥æ•°æ®</p>
            <p class="text-sm font-medium">æ­¥æ•°ã€å¿ƒç‡ã€å¡è·¯é‡Œæ¶ˆè€—</p>
          </div>
        </div>
        <button id="sync-garmin" class="w-full mt-4 bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all-300 flex items-center justify-center">
          <i class="fa fa-refresh mr-2"></i>
          ç«‹å³åŒæ­¥
        </button>
      </div>
      
      <!-- æ•°æ®å­˜å‚¨ -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">æ•°æ®å­˜å‚¨</h2>
        <div class="bg-blue-50 rounded-lg p-4">
          <div class="flex items-start">
            <div class="flex-shrink-0 mt-0.5">
              <i class="fa fa-cloud text-primary text-xl"></i>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-blue-800">æ•°æ®å·²åŒæ­¥è‡³äº‘ç«¯</h3>
              <p class="mt-1 text-sm text-blue-700">
                æ‚¨çš„æ‰€æœ‰å‡è„‚æ•°æ®å·²å®‰å…¨å­˜å‚¨åœ¨äº‘ç«¯ï¼Œå¯åœ¨å¤šè®¾å¤‡é—´åŒæ­¥è®¿é—®ã€‚
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <nav class="bg-white shadow-lg border-t border-gray-200 fixed bottom-0 left-0 right-0 z-10">
    <div class="container mx-auto px-4">
      <div class="flex justify-around py-3">
        <button class="nav-tab flex flex-col items-center" data-tab="dashboard-tab">
          <i class="fa fa-tachometer text-lg"></i>
          <span class="text-xs mt-1">ä»ªè¡¨ç›˜</span>
        </button>
        <button class="nav-tab active flex flex-col items-center" data-tab="calorie-tab">
          <i class="fa fa-cutlery text-lg"></i>
          <span class="text-xs mt-1">é¥®é£Ÿè®°å½•</span>
        </button>
        <button class="nav-tab flex flex-col items-center" data-tab="settings-tab">
          <i class="fa fa-user text-lg"></i>
          <span class="text-xs mt-1">æˆ‘çš„</span>
        </button>
      </div>
    </div>
  </nav>
  


  <!-- æ¨¡æ‹ŸAIåˆ†æçš„åŠ è½½å¼¹çª— -->
  <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-xs w-full mx-4">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold text-gray-700 mb-2">AI æ­£åœ¨åˆ†æ...</h3>
        <p id="loading-text" class="text-sm text-gray-500">æ­£åœ¨è¯†åˆ«é£Ÿç‰©æˆåˆ†å’Œè®¡ç®—è¥å…»å€¼</p>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // æ•°æ®æ¨¡å‹
    const appData = {
      userProfile: {
        id: "user123",
        name: "ç”¨æˆ·å",
        weightGoal: 5000, // ç›®æ ‡å‡è„‚å…‹æ•°
        currentWeightLoss: 3750, // å½“å‰å·²å‡è„‚å…‹æ•°
        startDate: "2025-07-01", // å¼€å§‹æ—¥æœŸ
        garminConnected: true, // Garminè¿æ¥çŠ¶æ€
        lastSync: "2025-07-21T08:30:00" // æœ€ååŒæ­¥æ—¶é—´
      },
      foodRecords: [
        {
          id: "rec1",
          date: "2025-07-21",
          time: "12:30",
          description: "åˆé¤ï¼šç‚¸é¸¡æ’ã€ç±³é¥­ã€è”¬èœ",
          calories: 650,
          protein: 35, // å…‹
          carbs: 50, // å…‹
          fat: 30, // å…‹
          aiAdvice: "ä¸‹åˆå¯ä»¥å¢åŠ ä¸€äº›æœ‰æ°§è¿åŠ¨ï¼Œå¸®åŠ©æ¶ˆè€—å¤šä½™çƒ­é‡ã€‚",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        },
        {
          id: "rec2",
          date: "2025-07-21",
          time: "08:00",
          description: "æ—©é¤ï¼šå…¨éº¦é¢åŒ…ã€é¸¡è›‹ã€ç‰›å¥¶",
          calories: 350,
          protein: 20, // å…‹
          carbs: 40, // å…‹
          fat: 12, // å…‹
          aiAdvice: "æ—©é¤æ­é…å‡è¡¡ï¼Œè›‹ç™½è´¨å……è¶³ï¼Œæœ‰åŠ©äºè‚Œè‚‰ç»´æŒã€‚",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        },
        {
          id: "rec3",
          date: "2025-07-20",
          time: "19:00",
          description: "æ™šé¤ï¼šçƒ¤é±¼ã€è”¬èœæ²™æ‹‰",
          calories: 450,
          protein: 40, // å…‹
          carbs: 20, // å…‹
          fat: 20, // å…‹
          aiAdvice: "æ™šé¤è¥å…»å‡è¡¡ï¼Œè„‚è‚ªå«é‡é€‚ä¸­ï¼Œæœ‰åŠ©äºå¤œé—´è„‚è‚ªç‡ƒçƒ§ã€‚",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        },
        {
          id: "rec4",
          date: "2025-07-20",
          time: "12:30",
          description: "åˆé¤ï¼šç‚¸é¸¡æ’ã€ç±³é¥­ã€è”¬èœ",
          calories: 650,
          protein: 35, // å…‹
          carbs: 50, // å…‹
          fat: 30, // å…‹
          aiAdvice: "ä¸‹åˆå¯ä»¥å¢åŠ ä¸€äº›æœ‰æ°§è¿åŠ¨ï¼Œå¸®åŠ©æ¶ˆè€—å¤šä½™çƒ­é‡ã€‚",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        },
        {
          id: "rec5",
          date: "2025-07-19",
          time: "12:30",
          description: "åˆé¤ï¼šç‚¸é¸¡æ’ã€ç±³é¥­ã€è”¬èœ",
          calories: 650,
          protein: 35, // å…‹
          carbs: 50, // å…‹
          fat: 30, // å…‹
          aiAdvice: "ä¸‹åˆå¯ä»¥å¢åŠ ä¸€äº›æœ‰æ°§è¿åŠ¨ï¼Œå¸®åŠ©æ¶ˆè€—å¤šä½™çƒ­é‡ã€‚",
          imageUrl: "https://p11-doubao-search-sign.byteimg.com/labis/4624334773342739966766428800025~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1765993624&x-signature=4Gzr%2F0F%2Bv6Lh6t%2Fg8j%2F%2Bf%2F9d6M8%3D"
        }
      ],
      dailySummaries: [
        {
          date: "2025-07-21",
          totalCaloriesIn: 1800,
          totalProtein: 120,
          totalCarbs: 150,
          totalFat: 65,
          totalCaloriesOut: 2300,
          trainingType: "both", // none, A, S, both
          fatChange: -40.56 // å…‹ï¼Œè´Ÿå€¼ä¸ºå‡è„‚
        }
      ],
      // ä¿å­˜å½“å‰ç¼–è¾‘çš„è®°å½•
      currentRecord: null
    };

    // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(e) {
      console.error('JavaScripté”™è¯¯:', e.message, 'åœ¨æ–‡ä»¶:', e.filename, 'è¡Œå·:', e.lineno);
      alert('å‘ç”Ÿé”™è¯¯: ' + e.message);
    });
    
    // DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ–åº”ç”¨
      initializeApp();
      
      // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª
      initNavigation();
      
      // åˆå§‹åŒ–ä»ªè¡¨ç›˜
      initDashboard();
      
      // åˆå§‹åŒ–å¡è·¯é‡Œè®°å½•é¡µé¢
      initCalorieRecord();
      
      // åˆå§‹åŒ–è®¾ç½®é¡µé¢
      initSettings();
      
      // åˆå§‹åŒ–æ¨¡æ€æ¡†
      initModals();
      
      // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤å€¼ä¸ºä»Šå¤©
      const recordDate = document.getElementById('record-date');
      if (recordDate) {
        const today = new Date().toISOString().split('T')[0];
        recordDate.value = today;
        console.log('ğŸ” [Init] è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤å€¼:', today);
      }
      
      // æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡é¥®é£Ÿè®°å½•æ›´æ–°
      updateCalorieRecords();
      
      // ä¸ºåº•éƒ¨å¯¼èˆªæ æ·»åŠ ç›´æ¥çš„ç‚¹å‡»äº‹ä»¶ç»‘å®š
      document.querySelector('[data-tab="dashboard-tab"]').addEventListener('click', function() {
        switchTab('dashboard-tab');
      });
      
      document.querySelector('[data-tab="calorie-tab"]').addEventListener('click', function() {
        switchTab('calorie-tab');
      });
      
      document.querySelector('[data-tab="settings-tab"]').addEventListener('click', function() {
        switchTab('settings-tab');
      });
    });
    
    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabId) {
      try {
        console.log('å°è¯•åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabId);
        
        // æ£€æŸ¥æ ‡ç­¾é¡µå…ƒç´ æ˜¯å¦å­˜åœ¨
        const tabElement = document.getElementById(tabId);
        if (!tabElement) {
          console.error('æ ‡ç­¾é¡µå…ƒç´ ä¸å­˜åœ¨:', tabId);
          return;
        }
        
        // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
        document.querySelectorAll('.nav-tab').forEach(t => {
          console.log('ç§»é™¤æ´»åŠ¨çŠ¶æ€:', t.getAttribute('data-tab'));
          t.classList.remove('active');
        });
        
        document.querySelectorAll('.tab-content').forEach(c => {
          console.log('éšè—æ ‡ç­¾é¡µ:', c.id);
          c.classList.remove('active');
        });
        
        // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
        const navTab = document.querySelector(`[data-tab="${tabId}"]`);
        if (navTab) {
          console.log('æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°å¯¼èˆªæŒ‰é’®:', tabId);
          navTab.classList.add('active');
        } else {
          console.error('å¯¼èˆªæŒ‰é’®ä¸å­˜åœ¨:', tabId);
        }
        
        console.log('æ˜¾ç¤ºæ ‡ç­¾é¡µ:', tabId);
        tabElement.classList.add('active');
        
        // éªŒè¯æ ‡ç­¾é¡µæ˜¯å¦æ˜¾ç¤º
        setTimeout(() => {
          const isActive = tabElement.classList.contains('active');
          console.log('æ ‡ç­¾é¡µ', tabId, 'æ˜¯å¦æ˜¾ç¤º:', isActive);
          
          if (!isActive) {
            console.error('æ ‡ç­¾é¡µæœªæ˜¾ç¤ºï¼Œæ‰‹åŠ¨æ·»åŠ activeç±»');
            tabElement.classList.add('active');
          }
        }, 100);
        
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        console.log('æˆåŠŸåˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:', tabId);
      } catch (error) {
        console.error('åˆ‡æ¢æ ‡ç­¾é¡µæ—¶å‘ç”Ÿé”™è¯¯:', error);
        alert('åˆ‡æ¢é¡µé¢æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
      }
    }

    // åˆå§‹åŒ–åº”ç”¨
    async function initializeApp() {
      // è®¾ç½®å½“å‰æ—¥æœŸ
      const today = new Date().toISOString().split('T')[0];
      const recordDateEl = document.getElementById('record-date');
      if (recordDateEl) {
        recordDateEl.value = today;
      }
      
      // ä»åç«¯åŠ è½½æ•°æ®
      console.log('ğŸš€ åˆå§‹åŒ–åº”ç”¨ï¼Œä»åç«¯åŠ è½½æ•°æ®...');
      try {
        const response = await window.apiClient.getRecords();
        if (response.success && response.data) {
          appData.foodRecords = response.data;
          console.log('âœ… åˆå§‹åŒ–æ•°æ®åŠ è½½æˆåŠŸï¼Œè®°å½•æ•°é‡:', appData.foodRecords.length);
        }
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–æ•°æ®åŠ è½½å¤±è´¥:', error);
        // å¦‚æœåç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°ç»„
        appData.foodRecords = [];
      }
      
      // æ›´æ–°UI
      updateUI();
    }

    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
    function checkLocalStorage() {
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„é€»è¾‘
      // å¦‚æœæœ‰æ•°æ®ï¼ŒåŠ è½½æœ¬åœ°æ•°æ®
      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
    }

    // æ›´æ–°UI
    function updateUI() {
      // æ›´æ–°ä»ªè¡¨ç›˜
      updateDashboard();
      
      // æ›´æ–°å¡è·¯é‡Œè®°å½•
      updateCalorieRecords();
      
      // æ›´æ–°è®¾ç½®é¡µé¢
      updateSettings();
    }

    // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª - ä¿ç•™ä½†æ·»åŠ è°ƒè¯•ä¿¡æ¯
    function initNavigation() {
      console.log('åˆå§‹åŒ–åº•éƒ¨å¯¼èˆª');
      const navTabs = document.querySelectorAll('.nav-tab');
      
      console.log('æ‰¾åˆ°å¯¼èˆªæŒ‰é’®æ•°é‡:', navTabs.length);
      
      navTabs.forEach(tab => {
        const tabId = tab.getAttribute('data-tab');
        console.log('ä¸ºå¯¼èˆªæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶:', tabId);
        
        tab.addEventListener('click', function(e) {
          console.log('å¯¼èˆªæŒ‰é’®è¢«ç‚¹å‡»:', tabId);
          
          // ç›´æ¥è°ƒç”¨åˆ‡æ¢å‡½æ•°
          switchTab(tabId);
          
          // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
          e.stopPropagation();
          e.preventDefault();
        });
      });
    }

    // åˆå§‹åŒ–ä»ªè¡¨ç›˜
    function initDashboard() {
      // æ›´æ–°è¿›åº¦ç¯
      updateProgressRing();
      
      // æ›´æ–°ä»Šæ—¥æ•°æ®
      updateTodayData();
      
      // åˆå§‹åŒ–æœˆæ—¥å†è§†å›¾
      initCalendarView();
      
      // ç”Ÿæˆå½“å‰æœˆçš„æ¨¡æ‹Ÿæ•°æ®
      const today = new Date();
      generateCalendarMockData(today.getFullYear(), today.getMonth());
      
      // æ›´æ–°AIå»ºè®®
      updateAIAdvice();
    }

    // æ›´æ–°ä»ªè¡¨ç›˜
    function updateDashboard() {
      // æ›´æ–°è¿›åº¦ç¯
      updateProgressRing();
      
      // æ›´æ–°ä»Šæ—¥æ•°æ®
      updateTodayData();
    }

    // æ›´æ–°è¿›åº¦ç¯
    function updateProgressRing() {
      const { weightGoal, currentWeightLoss, startDate } = appData.userProfile;
      const progress = (currentWeightLoss / weightGoal) * 100;
      
      // æ›´æ–°ç™¾åˆ†æ¯”æ–‡æœ¬
      document.getElementById('progress-percentage').textContent = `${Math.round(progress)}%`;
      
      // æ›´æ–°è¿›åº¦ç¯
      const circle = document.getElementById('progress-circle');
      const radius = circle.r.baseVal.value;
      const circumference = radius * 2 * Math.PI;
      
      circle.style.strokeDasharray = `${circumference} ${circumference}`;
      const offset = circumference - (progress / 100) * circumference;
      circle.style.strokeDashoffset = offset;
      
      // æ›´æ–°ç›®æ ‡å’Œå½“å‰å‡è„‚é‡
      document.getElementById('weight-goal').textContent = `${(weightGoal / 1000).toFixed(1)}`;
      document.getElementById('current-loss').textContent = `${(currentWeightLoss / 1000).toFixed(2)}`;
      
      // è®¡ç®—å·²è®°å½•å¤©æ•°
      const start = new Date(startDate);
      const today = new Date();
      const diffTime = Math.abs(today - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      const recordedDaysEl = document.getElementById('recorded-days');
      if (recordedDaysEl) {
        recordedDaysEl.textContent = `${diffDays}`;
      }
      
      // è®¡ç®—å‰©ä½™å¤©æ•°ï¼ˆåŸºäºç”¨æˆ·çš„å¹³å‡å‡è„‚é€Ÿåº¦ï¼‰
      const averageDailyLoss = diffDays > 0 ? currentWeightLoss / diffDays : 0; // å…‹/å¤©
      const remainingWeight = weightGoal - currentWeightLoss;
      const remainingDays = averageDailyLoss > 0 ? Math.ceil(remainingWeight / averageDailyLoss) : 0;
      
      const remainingDaysEl = document.getElementById('remaining-days');
      if (remainingDaysEl) {
        remainingDaysEl.textContent = `${remainingDays}`;
      }
    }

    // æ›´æ–°ä»Šæ—¥æ•°æ®
    function updateTodayData() {
      const today = new Date().toISOString().split('T')[0];
      const summary = appData.dailySummaries.find(s => s.date === today) || {
        totalCaloriesIn: 0,
        totalProtein: 0,
        totalCarbs: 0,
        totalFat: 0,
        totalCaloriesOut: 2000,
        trainingType: "none",
        fatChange: 0
      };
      
      // æ›´æ–°æ‘„å…¥å’Œæ¶ˆè€—
      const caloriesInEl = document.getElementById('calories-in');
      const caloriesOutEl = document.getElementById('calories-out');
      if (caloriesInEl) {
        caloriesInEl.textContent = `${summary.totalCaloriesIn} kcal`;
      }
      if (caloriesOutEl) {
        caloriesOutEl.textContent = `${summary.totalCaloriesOut} kcal`;
      }
      
      // æ›´æ–°æ‘„å…¥æ¶ˆè€—å¯¹æ¯”æ¡
      const caloriesInBar = document.getElementById('calories-in-bar');
      const caloriesOutBar = document.getElementById('calories-out-bar');
      
      // è®¡ç®—æ€»çƒ­é‡
      const totalCalories = summary.totalCaloriesIn + summary.totalCaloriesOut;
      
      // è®¡ç®—ç™¾åˆ†æ¯”
      let inPercentage = 0;
      let outPercentage = 0;
      
      if (totalCalories > 0) {
        inPercentage = (summary.totalCaloriesIn / totalCalories) * 100;
        outPercentage = (summary.totalCaloriesOut / totalCalories) * 100;
      }
      
      // æ›´æ–°å®½åº¦
      caloriesInBar.style.width = `${inPercentage}%`;
      caloriesOutBar.style.width = `${outPercentage}%`;
      
      // ç¡®ä¿æ–‡å­—ä¸é‡å 
      if (inPercentage > 10) {
        caloriesInBar.querySelector('span').style.display = 'block';
      } else {
        caloriesInBar.querySelector('span').style.display = 'none';
      }
      
      if (outPercentage > 10) {
        caloriesOutBar.querySelector('span').style.display = 'block';
      } else {
        caloriesOutBar.querySelector('span').style.display = 'none';
      }
      
      // æ›´æ–°å®é‡è¥å…»ç´ 
      const proteinEl = document.getElementById('protein');
      const carbsEl = document.getElementById('carbs');
      const fatEl = document.getElementById('fat');
      if (proteinEl) {
        proteinEl.textContent = `${summary.totalProtein}`;
      }
      if (carbsEl) {
        carbsEl.textContent = `${summary.totalCarbs}`;
      }
      if (fatEl) {
        fatEl.textContent = `${summary.totalFat}`;
      }
      
      // æ›´æ–°çƒ­é‡å¹³è¡¡
      const calorieBalance = document.getElementById('calorie-balance');
      const balance = summary.totalCaloriesOut - summary.totalCaloriesIn;
      
      if (balance > 0) {
        calorieBalance.innerHTML = `<i class="fa fa-arrow-down mr-1"></i>${balance} kcal`;
        calorieBalance.className = 'text-sm font-medium px-2 py-1 rounded-full bg-green-100 text-green-800';
      } else {
        calorieBalance.innerHTML = `<i class="fa fa-arrow-up mr-1"></i>${Math.abs(balance)} kcal`;
        calorieBalance.className = 'text-sm font-medium px-2 py-1 rounded-full bg-red-100 text-red-800';
      }
      
      // æ›´æ–°è„‚è‚ªå˜åŒ–
      const fatChangeEl = document.getElementById('fat-change');
      const fatChangeIcon = document.getElementById('fat-change-icon');
      const fatChangeStatus = document.getElementById('fat-change-status');
      
      if (summary.fatChange < 0) {
        // å‡è„‚
        fatChangeEl.textContent = `-${Math.abs(summary.fatChange).toFixed(2)}g`;
        fatChangeEl.className = 'text-3xl font-bold text-green-600';
        fatChangeIcon.className = 'fa fa-arrow-down text-green-600 mr-1';
        fatChangeIcon.textContent = ''; // æ¸…ç©ºæ–‡æœ¬å†…å®¹ï¼Œåªä¿ç•™å›¾æ ‡
        fatChangeStatus.textContent = 'å‡è„‚ä¸­';
      } else {
        // å¢è„‚
        fatChangeEl.textContent = `+${summary.fatChange.toFixed(2)}g`;
        fatChangeEl.className = 'text-3xl font-bold text-red-600';
        fatChangeIcon.className = 'fa fa-arrow-up text-red-600 mr-1';
        fatChangeIcon.textContent = ''; // æ¸…ç©ºæ–‡æœ¬å†…å®¹ï¼Œåªä¿ç•™å›¾æ ‡
        fatChangeStatus.textContent = 'å¢è„‚ä¸­';
      }
    }

    // æ›´æ–°æœˆæ—¥å†è§†å›¾
    function updateCalendarView(year, month) {
      const calendarGrid = document.getElementById('calendar-grid');
      const currentMonthEl = document.getElementById('current-month');
      
      // æ¸…ç©ºæ—¥å†
      calendarGrid.innerHTML = '';
      
      // è®¾ç½®å½“å‰æœˆä»½æ˜¾ç¤º
      const date = new Date(year, month);
      const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
      currentMonthEl.textContent = `${year}å¹´${monthNames[month]}`;
      
      // è·å–å½“æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
      const firstDay = new Date(year, month, 1).getDay();
      
      // è·å–å½“æœˆå¤©æ•°
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // æ·»åŠ ç©ºç™½æ ¼å­
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day';
        calendarGrid.appendChild(emptyDay);
      }
      
      // æ·»åŠ æ—¥æœŸæ ¼å­
      for (let day = 1; day <= daysInMonth; day++) {
        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const summary = appData.dailySummaries.find(s => s.date === dateString);
        
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        
        if (summary) {
          if (summary.fatChange < 0) {
            dayEl.classList.add('loss');
          } else if (summary.fatChange > 0) {
            dayEl.classList.add('gain');
          }
        }
        
        const dayText = document.createElement('p');
        dayText.className = 'text-sm';
        dayText.textContent = day;
        
        dayEl.appendChild(dayText);
        calendarGrid.appendChild(dayEl);
      }
      
      // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®å¡«å……æ—¥å†
      generateCalendarMockData(year, month);
    }
    
    // ç”Ÿæˆæ—¥å†æ¨¡æ‹Ÿæ•°æ®
    function generateCalendarMockData(year, month) {
      // ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ¨¡æ‹Ÿæ•°æ®
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // ä¸ºæ¯ä¸ªæ—¥æœŸç”Ÿæˆéšæœºè„‚è‚ªå˜åŒ–æ•°æ®
      for (let day = 1; day <= daysInMonth; day++) {
        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // å¦‚æœå·²ç»æœ‰æ•°æ®ï¼Œè·³è¿‡
        if (appData.dailySummaries.find(s => s.date === dateString)) {
          continue;
        }
        
        // éšæœºç”Ÿæˆè„‚è‚ªå˜åŒ–ï¼ˆ-50åˆ°10å…‹ä¹‹é—´ï¼‰
        const fatChange = (Math.random() * 60 - 50).toFixed(2);
        
        // æ·»åŠ åˆ°æ•°æ®ä¸­
        appData.dailySummaries.push({
          date: dateString,
          totalCaloriesIn: Math.floor(Math.random() * 500) + 1500,
          totalProtein: Math.floor(Math.random() * 50) + 80,
          totalCarbs: Math.floor(Math.random() * 80) + 100,
          totalFat: Math.floor(Math.random() * 30) + 40,
          totalCaloriesOut: Math.floor(Math.random() * 500) + 2000,
          trainingType: ["none", "A", "S", "both"][Math.floor(Math.random() * 4)],
          fatChange: parseFloat(fatChange)
        });
      }
    }
    
    // åˆå§‹åŒ–æœˆæ—¥å†è§†å›¾
    function initCalendarView() {
      const today = new Date();
      let currentYear = today.getFullYear();
      let currentMonth = today.getMonth();
      
      // æ›´æ–°æ—¥å†
      updateCalendarView(currentYear, currentMonth);
      
      // ä¸Šä¸€ä¸ªæœˆæŒ‰é’®ç‚¹å‡»
      document.getElementById('prev-month').addEventListener('click', function() {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        updateCalendarView(currentYear, currentMonth);
      });
      
      // ä¸‹ä¸€ä¸ªæœˆæŒ‰é’®ç‚¹å‡»
      document.getElementById('next-month').addEventListener('click', function() {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateCalendarView(currentYear, currentMonth);
      });
    }

    // æ›´æ–°AIå»ºè®®
    function updateAIAdvice() {
      const adviceOptions = [
        "ä»Šå¤©çš„è®­ç»ƒå’Œé¥®é£Ÿæ­é…å¾ˆå¥½ï¼ç»§ç»­ä¿æŒè¿™ä¸ªèŠ‚å¥ï¼Œé¢„è®¡è¿˜éœ€è¦7å¤©å°±èƒ½è¾¾æˆç›®æ ‡ã€‚æ™šä¸Šå¯ä»¥é€‚å½“æ”¾æ¾ï¼Œä½†ä¸è¦ç†¬å¤œã€‚",
        "ä½ çš„å‡è„‚è¿›åº¦ä¸é”™ï¼Œä½†è›‹ç™½è´¨æ‘„å…¥ç•¥ä½ã€‚å»ºè®®å¢åŠ é¸¡èƒ¸è‚‰ã€é±¼æˆ–è±†ç±»ç­‰é«˜è›‹ç™½é£Ÿç‰©çš„æ‘„å…¥ï¼Œæœ‰åŠ©äºè‚Œè‚‰ç»´æŒã€‚",
        "ä»Šå¤©çš„çƒ­é‡èµ¤å­—é€‚ä¸­ï¼Œè®­ç»ƒå¼ºåº¦ä¹Ÿå¾ˆå¥½ã€‚è®°å¾—å¤šå–æ°´ï¼Œä¿æŒèº«ä½“æ°´åˆ†å……è¶³ï¼Œæœ‰åŠ©äºæ–°é™ˆä»£è°¢ã€‚",
        "ä½ çš„ç¢³æ°´åŒ–åˆç‰©æ‘„å…¥æœ‰ç‚¹é«˜ï¼Œç‰¹åˆ«æ˜¯ç²¾åˆ¶ç¢³æ°´ã€‚å»ºè®®æ›¿æ¢ä¸ºå…¨éº¦ã€ç‡•éº¦ç­‰å¤åˆç¢³æ°´åŒ–åˆç‰©ï¼Œé¥±è…¹æ„Ÿæ›´å¼ºã€‚",
        "æœ¬å‘¨å‡è„‚æ•ˆæœæ˜¾è‘—ï¼å‘¨æœ«å¯ä»¥é€‚å½“æ”¾æ¾é¥®é£Ÿï¼Œä½†ä¸è¦å®Œå…¨æ”¾çºµï¼Œä»¥å…å½±å“æ•´ä½“è¿›åº¦ã€‚"
      ];
      
      const randomAdvice = adviceOptions[Math.floor(Math.random() * adviceOptions.length)];
      const aiAdviceEl = document.getElementById('ai-advice');
      if (aiAdviceEl) {
        aiAdviceEl.textContent = randomAdvice;
      } else {
        console.warn('âš ï¸ æ‰¾ä¸åˆ° ai-advice å…ƒç´ ');
      }
    }

    // åˆå§‹åŒ–å¡è·¯é‡Œè®°å½•é¡µé¢
    function initCalorieRecord() {
      console.log('å¼€å§‹åˆå§‹åŒ–ä¸Šä¼ åŠŸèƒ½...');
      
      // å›¾ç‰‡ä¸Šä¼  - é‡æ–°å®ç°
      const foodImage = document.getElementById('food-image');
      const imagePreview = document.getElementById('image-preview');
      const uploadPlaceholder = document.getElementById('upload-placeholder');
      const uploadArea = document.getElementById('upload-area');
      
      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!foodImage) {
        console.error('âŒ æ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥æ¡†');
        return;
      }
      if (!imagePreview) {
        console.error('âŒ æ‰¾ä¸åˆ°å›¾ç‰‡é¢„è§ˆåŒºåŸŸ');
        return;
      }
      if (!uploadPlaceholder) {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸Šä¼ å ä½ç¬¦');
        return;
      }
      if (!uploadArea) {
        console.error('âŒ æ‰¾ä¸åˆ°ä¸Šä¼ åŒºåŸŸ');
        return;
      }
      
      console.log('âœ… æ‰€æœ‰ä¸Šä¼ å…ƒç´ å·²æ‰¾åˆ°');
      
      // åˆ›å»ºæ–°çš„ä¸Šä¼ å¤„ç†å‡½æ•° - ä½¿ç”¨åŠ¨æ€åˆ›å»ºæ–‡ä»¶è¾“å…¥æ¡†çš„æ–¹æ³•
      function handleUploadClick(e) {
        console.log('ğŸ–±ï¸ ä¸Šä¼ åŒºåŸŸè¢«ç‚¹å‡»');
        e.preventDefault();
        e.stopPropagation();
        
        console.log('ğŸ“ åˆ›å»ºæ–°çš„æ–‡ä»¶è¾“å…¥æ¡†...');
        
        // åˆ›å»ºæ–°çš„æ–‡ä»¶è¾“å…¥æ¡†ï¼ˆæµ‹è¯•è¯æ˜è¿™ä¸ªæ–¹æ³•æœ‰æ•ˆï¼‰
        const newFileInput = document.createElement('input');
        newFileInput.type = 'file';
        newFileInput.accept = 'image/*';
        newFileInput.style.position = 'absolute';
        newFileInput.style.left = '-9999px';
        newFileInput.style.opacity = '0';
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(newFileInput);
        
        // ç»‘å®šæ–‡ä»¶é€‰æ‹©äº‹ä»¶
        newFileInput.addEventListener('change', function(e) {
          console.log('ğŸ“‚ æ–°æ–‡ä»¶è¾“å…¥æ¡†è§¦å‘');
          const file = e.target.files[0];
          
          if (file) {
            console.log('âœ… æ–‡ä»¶å·²é€‰æ‹©:', file.name, 'å¤§å°:', file.size, 'bytes');
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
              alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
              return;
            }
            
            // è¯»å–æ–‡ä»¶å¹¶æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
              console.log('ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½å®Œæˆ');
              
              // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
              const img = imagePreview.querySelector('img');
              if (img) {
                img.src = e.target.result;
                imagePreview.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
                console.log('âœ… å›¾ç‰‡é¢„è§ˆå·²æ˜¾ç¤º');
              }
            };
            
            reader.readAsDataURL(file);
          }
          
          // æ¸…ç†ä¸´æ—¶æ–‡ä»¶è¾“å…¥æ¡†
          setTimeout(() => {
            if (document.body.contains(newFileInput)) {
              document.body.removeChild(newFileInput);
              console.log('ğŸ§¹ å·²æ¸…ç†ä¸´æ—¶æ–‡ä»¶è¾“å…¥æ¡†');
            }
          }, 1000);
        });
        
        // è§¦å‘ç‚¹å‡»
        try {
          newFileInput.click();
          console.log('âœ… æ–°æ–‡ä»¶é€‰æ‹©å™¨å·²è§¦å‘');
        } catch (error) {
          console.error('âŒ æ–°æ–‡ä»¶é€‰æ‹©å™¨è§¦å‘å¤±è´¥:', error);
          // æ¸…ç†
          if (document.body.contains(newFileInput)) {
            document.body.removeChild(newFileInput);
          }
        }
      }
      
      // è¿™ä¸ªå‡½æ•°ç°åœ¨ä¸éœ€è¦äº†ï¼Œå› ä¸ºæ–‡ä»¶é€‰æ‹©é€»è¾‘å·²ç»ç§»åˆ° handleUploadClick ä¸­
      function handleFileSelect(e) {
        console.log('ğŸ“‚ åŸå§‹æ–‡ä»¶é€‰æ‹©å™¨è§¦å‘ï¼ˆåº”è¯¥ä¸ä¼šç”¨åˆ°ï¼‰');
        // è¿™ä¸ªå‡½æ•°ä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼Œä½†ä¸»è¦é€»è¾‘å·²ç§»åˆ° handleUploadClick ä¸­
      }
      
      // ç»‘å®šäº‹ä»¶
      uploadArea.addEventListener('click', handleUploadClick);
      foodImage.addEventListener('change', handleFileSelect);
      
      console.log('âœ… ä¸Šä¼ åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
      
      // åŠ è½½å†å²è®°å½•
      if (typeof loadHistoryRecords === 'function') {
        loadHistoryRecords();
      }
      
      // å†å²è®°å½•ç‚¹å‡»äº‹ä»¶å§”æ‰˜
      const historyRecords = document.getElementById('history-records');
      if (historyRecords) {
        historyRecords.addEventListener('click', function(e) {
          const recordItem = e.target.closest('.history-record-item');
          if (recordItem) {
            const recordId = recordItem.getAttribute('data-id');
            if (typeof loadRecordToForm === 'function') {
              loadRecordToForm(recordId);
            }
          }
        });
      }
      
      // AIåˆ†æå‡½æ•° - ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
      async function callAIAnalysis(imageData, desc) {
        try {
          console.log('ğŸ”„ å¼€å§‹AIåˆ†æ...');
          console.log('ğŸ“ æè¿°:', desc);
          console.log('ğŸ–¼ï¸ å›¾ç‰‡:', imageData ? 'æœ‰å›¾ç‰‡' : 'æ— å›¾ç‰‡');
          console.log('ğŸ–¼ï¸ å›¾ç‰‡æ•°æ®é•¿åº¦:', imageData ? imageData.length : 0);
          
          // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ•°æ®ä½†æ²¡æœ‰ä¼ é€’ç»™AI
          if (!imageData && foodImage.files && foodImage.files[0]) {
            console.error('âŒ å›¾ç‰‡æ–‡ä»¶å­˜åœ¨ä½†æ²¡æœ‰ä¼ é€’ç»™AIåˆ†æï¼');
            alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ å›¾ç‰‡');
            hideLoadingModal();
            return;
          }
          
          // è°ƒç”¨çœŸå®AIåˆ†æï¼ˆå¼‚æ­¥ï¼‰
          const result = await simulateAIAnalysis(imageData, desc);
          
          console.log('âœ… AIåˆ†æå®Œæˆï¼Œç»“æœ:', result);
          
          // éšè—åŠ è½½å¼¹çª—
          hideLoadingModal();
          
          // æ˜¾ç¤ºåˆ†æç»“æœ
          showAnalysisResult(result);
        } catch (error) {
          console.error('âŒ AIåˆ†æå¤±è´¥:', error);
          hideLoadingModal();
          alert('AIåˆ†æå¤±è´¥: ' + error.message);
        }
      }
      
      // åˆ†ææŒ‰é’®ç‚¹å‡»
      const analyzeBtn = document.getElementById('analyze-btn');
      analyzeBtn.addEventListener('click', function() {
        const description = document.getElementById('food-description').value;
        const foodImage = document.getElementById('food-image');
        const imagePreview = document.getElementById('image-preview');
        const img = imagePreview ? imagePreview.querySelector('img') : null;
        
        console.log('ğŸ” [Analyze] å¼€å§‹åˆ†ææ£€æŸ¥...');
        console.log('ğŸ” [Analyze] æè¿°:', description);
        console.log('ğŸ” [Analyze] foodImageå…ƒç´ :', foodImage);
        console.log('ğŸ” [Analyze] foodImage.files:', foodImage ? foodImage.files : 'N/A');
        console.log('ğŸ” [Analyze] files.length:', foodImage && foodImage.files ? foodImage.files.length : 0);
        console.log('ğŸ” [Analyze] å›¾ç‰‡é¢„è§ˆå…ƒç´ :', imagePreview);
        console.log('ğŸ” [Analyze] å›¾ç‰‡å…ƒç´ :', img);
        console.log('ğŸ” [Analyze] å›¾ç‰‡æ˜¯å¦éšè—:', imagePreview ? imagePreview.classList.contains('hidden') : 'N/A');
        console.log('ğŸ” [Analyze] å›¾ç‰‡src:', img ? img.src : 'N/A');
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡ï¼ˆé€šè¿‡é¢„è§ˆæˆ–æ–‡ä»¶è¾“å…¥æ¡†ï¼‰
        const hasImage = (img && img.src && !imagePreview.classList.contains('hidden')) || 
                        (foodImage && foodImage.files && foodImage.files.length > 0);
        
        if (!description && !hasImage) {
          console.log('âŒ [Analyze] æ²¡æœ‰æè¿°ä¹Ÿæ²¡æœ‰å›¾ç‰‡');
          alert('è¯·ä¸Šä¼ å›¾ç‰‡æˆ–å¡«å†™é£Ÿç‰©æè¿°');
          return;
        }
        
        // æ˜¾ç¤ºåŠ è½½å¼¹çª—
        showLoadingModal('æ­£åœ¨åˆ†æé£Ÿç‰©æˆåˆ†...');
        
        // è·å–å›¾ç‰‡æ•°æ®
        let imageBase64 = null;
        
        // ä¼˜å…ˆä»æ–‡ä»¶è¾“å…¥æ¡†è·å–
        if (foodImage && foodImage.files && foodImage.files[0]) {
          console.log('ğŸ–¼ï¸ ä»æ–‡ä»¶è¾“å…¥æ¡†è¯»å–å›¾ç‰‡...');
          const reader = new FileReader();
          reader.onload = function(e) {
            imageBase64 = e.target.result;
            console.log('ğŸ–¼ï¸ å›¾ç‰‡è¯»å–å®Œæˆï¼Œå¤§å°:', imageBase64.length, 'å­—ç¬¦');
            // è°ƒç”¨çœŸå®AIåˆ†æ
            callAIAnalysis(imageBase64, description);
          };
          reader.readAsDataURL(foodImage.files[0]);
        } 
        // å¦‚æœæ–‡ä»¶è¾“å…¥æ¡†æ²¡æœ‰æ–‡ä»¶ï¼Œå°è¯•ä»é¢„è§ˆå›¾ç‰‡è·å–
        else if (img && img.src && !imagePreview.classList.contains('hidden')) {
          console.log('ğŸ–¼ï¸ ä»é¢„è§ˆå›¾ç‰‡è·å–æ•°æ®...');
          imageBase64 = img.src;
          console.log('ğŸ–¼ï¸ é¢„è§ˆå›¾ç‰‡æ•°æ®å¤§å°:', imageBase64.length, 'å­—ç¬¦');
          // è°ƒç”¨çœŸå®AIåˆ†æ
          callAIAnalysis(imageBase64, description);
        } 
        // å¦‚æœéƒ½æ²¡æœ‰ï¼Œç›´æ¥åˆ†ææè¿°
        else {
          console.log('âš ï¸ æ²¡æœ‰å›¾ç‰‡æ•°æ®ï¼Œç›´æ¥åˆ†ææè¿°');
          callAIAnalysis(null, description);
        }
      });
      
      // ä¿å­˜è®°å½•æŒ‰é’®ç‚¹å‡»
      const saveRecordBtn = document.getElementById('save-record');
      saveRecordBtn.addEventListener('click', function() {
        console.log('ğŸ’¾ å¼€å§‹ä¿å­˜è®°å½•...');
        
        if (!appData.currentRecord) {
          console.log('âŒ æ²¡æœ‰åˆ†æç»“æœï¼Œæ— æ³•ä¿å­˜');
          alert('è¯·å…ˆåˆ†æé£Ÿç‰©æˆåˆ†');
          return;
        }
        
        // 1. è·å–æè¿°
        const descriptionEl = document.getElementById('food-description');
        const description = descriptionEl ? descriptionEl.value.trim() : '';
        console.log('ğŸ“ æè¿°:', description);
        
        // 2. è·å–å›¾ç‰‡
        const imagePreview = document.getElementById('image-preview');
        const img = imagePreview ? imagePreview.querySelector('img') : null;
        const imageSrc = (imagePreview && !imagePreview.classList.contains('hidden') && img && img.src) ? img.src : null;
        console.log('ğŸ–¼ï¸ å›¾ç‰‡:', imageSrc ? 'æœ‰å›¾ç‰‡' : 'æ— å›¾ç‰‡');
        console.log('ğŸ–¼ï¸ å›¾ç‰‡è¯¦æƒ…:', {
          imagePreview: !!imagePreview,
          img: !!img,
          hidden: imagePreview ? imagePreview.classList.contains('hidden') : 'N/A',
          src: img ? img.src.substring(0, 50) + '...' : 'N/A'
        });
        
        // 3. åˆ›å»ºè®°å½•å¯¹è±¡
        const record = {
          id: 'rec_' + Date.now(),
          date: new Date().toISOString().split('T')[0],
          time: new Date().toTimeString().split(' ')[0].substring(0, 5),
          description: description || 'æœªå‘½åé£Ÿç‰©',
          calories: appData.currentRecord.calories,
          protein: appData.currentRecord.protein,
          carbs: appData.currentRecord.carbs,
          fat: appData.currentRecord.fat,
          aiAdvice: appData.currentRecord.advice,
          image: imageSrc
        };
        
        console.log('ğŸ“‹ è®°å½•å¯¹è±¡:', record);
        
        // 4. ä¿å­˜åˆ°åç«¯æ•°æ®åº“
        console.log('ğŸŒ å¼€å§‹ä¿å­˜åˆ°åç«¯æ•°æ®åº“...');
        try {
          const response = await window.apiClient.saveRecord(record);
          console.log('âœ… åç«¯ä¿å­˜æˆåŠŸ:', response);
          
          // ä¿å­˜æˆåŠŸåæ·»åŠ åˆ°æœ¬åœ°æ•°ç»„
          appData.foodRecords.unshift(record);
          console.log('âœ… è®°å½•å·²æ·»åŠ åˆ°æœ¬åœ°æ•°æ®æ•°ç»„');
          console.log('ğŸ“Š å½“å‰è®°å½•æ€»æ•°:', appData.foodRecords.length);
          
        } catch (error) {
          console.error('âŒ åç«¯ä¿å­˜å¤±è´¥:', error);
          alert('ä¿å­˜å¤±è´¥: ' + error.message);
          return;
        }
        
        // 5. æ›´æ–°UI
        updateCalorieRecords();
        loadHistoryRecords();
        updateDailySummary();
        
        // 6. å¼ºåˆ¶åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
        setTimeout(() => {
          loadHistoryRecords();
          console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°å†å²è®°å½•å®Œæˆ');
        }, 100);
        
        // 6. éšè—åˆ†æç»“æœ
        const analysisResult = document.getElementById('analysis-result');
        if (analysisResult) {
          analysisResult.classList.add('hidden');
        }
        
        // 7. é‡ç½®è¡¨å•
        resetCalorieForm();
        
        // 8. æ˜¾ç¤ºæˆåŠŸæç¤º
        alert('è®°å½•å·²ä¿å­˜ï¼');
        console.log('ğŸ‰ ä¿å­˜å®Œæˆ');
      });
      
      // æ·»åŠ è®°å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶å§”æ‰˜
      document.addEventListener('click', function(e) {
        if (e.target.closest('.add-record-btn')) {
          const recordId = e.target.closest('.add-record-btn').getAttribute('data-id');
          loadRecordToForm(recordId);
        }
      });
      
      // å–æ¶ˆè®°å½•æŒ‰é’®ç‚¹å‡»
      const cancelRecordBtn = document.getElementById('cancel-record');
      cancelRecordBtn.addEventListener('click', function() {
        // é‡ç½®è¡¨å•
        resetCalorieForm();
        
        // éšè—åˆ†æç»“æœ
        document.getElementById('analysis-result').classList.add('hidden');
      });
      
      // æ—¥æœŸé€‰æ‹©å™¨å˜åŒ–
      const recordDate = document.getElementById('record-date');
      recordDate.addEventListener('change', function() {
        updateCalorieRecords();
      });
      
      // åˆ é™¤è®°å½•æŒ‰é’®ç‚¹å‡»
      document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-record')) {
          const recordId = e.target.closest('.delete-record').getAttribute('data-id');
          
          if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
            // åˆ é™¤è®°å½•
            appData.foodRecords = appData.foodRecords.filter(record => record.id !== recordId);
            
            // æ›´æ–°æ¯æ—¥æ±‡æ€»
            updateDailySummary();
            
            // æ›´æ–°UI
            updateUI();
          }
        }
      });
    }

    // æ›´æ–°å¡è·¯é‡Œè®°å½•
    function updateCalorieRecords() {
      console.log('ğŸ” [Calorie Records] å¼€å§‹æ›´æ–°é¥®é£Ÿè®°å½•...');
      
      const date = document.getElementById('record-date').value;
      console.log('ğŸ” [Calorie Records] é€‰æ‹©æ—¥æœŸ:', date);
      console.log('ğŸ” [Calorie Records] æ‰€æœ‰è®°å½•:', appData.foodRecords);
      
      const records = appData.foodRecords.filter(record => record.date === date);
      console.log('ğŸ” [Calorie Records] è¿‡æ»¤åçš„è®°å½•:', records);
      
      const timeline = document.getElementById('records-timeline');
      const noRecords = document.getElementById('no-records');
      
      // æ¸…ç©ºæ—¶é—´è½´
      timeline.innerHTML = '';
      
      if (records.length === 0) {
        console.log('ğŸ” [Calorie Records] æ²¡æœ‰æ‰¾åˆ°è®°å½•ï¼Œæ˜¾ç¤ºæ— è®°å½•çŠ¶æ€');
        // æ˜¾ç¤ºæ— è®°å½•çŠ¶æ€
        timeline.classList.add('hidden');
        noRecords.classList.remove('hidden');
        return;
      }
      
      // æ˜¾ç¤ºæ—¶é—´è½´
      timeline.classList.remove('hidden');
      noRecords.classList.add('hidden');
      
      // æ·»åŠ è®°å½•é¡¹
      records.forEach(record => {
        const recordItem = document.createElement('div');
        recordItem.className = 'history-record-item';
        
        // æ„å»ºHTML - æ›´å°çš„å¡ç‰‡
        let recordHTML = `
          <div class="bg-white border border-gray-200 rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-2">
              <div class="flex-1">
                <h3 class="text-xs font-medium text-gray-900 truncate">${record.description || 'æœªå‘½åé£Ÿç‰©'}</h3>
                <p class="text-xs text-gray-500">${record.time} â€¢ ${record.calories}kcal</p>
              </div>
              <div class="flex items-center space-x-1">
                <button class="text-primary hover:text-blue-700 add-record-btn" data-id="${record.id}" title="æ·»åŠ åˆ°è¡¨å•">
                  <i class="fa fa-plus-circle text-sm"></i>
                </button>
                <button class="text-gray-400 hover:text-red-500 delete-record" data-id="${record.id}" title="åˆ é™¤è®°å½•">
                  <i class="fa fa-trash-o text-sm"></i>
                </button>
              </div>
            </div>
        `;
        
        // å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ - æ›´å°çš„å›¾ç‰‡
        const imageSrc = record.image || record.imageUrl; // å…¼å®¹ä¸¤ç§å­—æ®µ
        if (imageSrc) {
          recordHTML += `
            <div class="mb-2">
              <img src="${imageSrc}" alt="é£Ÿç‰©å›¾ç‰‡" class="w-full h-16 object-cover rounded border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity" onclick="showImageModal('${imageSrc}')">
            </div>
          `;
        } else {
          // æ²¡æœ‰å›¾ç‰‡æ—¶æ˜¾ç¤ºå ä½ç¬¦
          recordHTML += `
            <div class="mb-2">
              <div class="w-full h-16 bg-gray-100 rounded border border-gray-200 flex items-center justify-center">
                <div class="text-center text-gray-400">
                  <i class="fa fa-camera text-lg"></i>
                </div>
              </div>
            </div>
          `;
        }
        
        recordHTML += `
          <div class="grid grid-cols-4 gap-2">
            <div class="text-center bg-gray-50 rounded p-2">
              <p class="text-xs text-gray-500">çƒ­é‡</p>
              <p class="text-sm font-medium text-gray-900">${record.calories}<span class="text-xs">kcal</span></p>
            </div>
            <div class="text-center bg-gray-50 rounded p-2">
              <p class="text-xs text-gray-500">è›‹ç™½è´¨</p>
              <p class="text-sm font-medium text-gray-900">${record.protein}<span class="text-xs">g</span></p>
            </div>
            <div class="text-center bg-gray-50 rounded p-2">
              <p class="text-xs text-gray-500">ç¢³æ°´</p>
              <p class="text-sm font-medium text-gray-900">${record.carbs}<span class="text-xs">g</span></p>
            </div>
            <div class="text-center bg-gray-50 rounded p-2">
              <p class="text-xs text-gray-500">è„‚è‚ª</p>
              <p class="text-sm font-medium text-gray-900">${record.fat}<span class="text-xs">g</span></p>
            </div>
          </div>
          <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
            <i class="fa fa-lightbulb-o mr-1"></i> ${record.aiAdvice}
          </div>
        `;
        
        recordItem.innerHTML = recordHTML;
        timeline.appendChild(recordItem);
      });
      
      // æ›´æ–°å†å²è®°å½•å¿«æ·é€‰æ‹©
      loadHistoryRecords();
    }
    
    // åŠ è½½å†å²è®°å½•åˆ°å¿«æ·é€‰æ‹©
    async function loadHistoryRecords() {
      const historyContainer = document.getElementById('history-records');
      
      console.log('ğŸ” [History] å¼€å§‹åŠ è½½å†å²è®°å½•...');
      
      // ä»åç«¯åŠ è½½æ•°æ®
      try {
        console.log('ğŸŒ ä»åç«¯åŠ è½½å†å²è®°å½•...');
        const response = await window.apiClient.getRecords();
        console.log('âœ… åç«¯æ•°æ®åŠ è½½æˆåŠŸ:', response);
        
        if (response.success && response.data) {
          appData.foodRecords = response.data;
          console.log('ğŸ“Š æ›´æ–°æœ¬åœ°æ•°æ®ï¼Œè®°å½•æ•°é‡:', appData.foodRecords.length);
        }
      } catch (error) {
        console.error('âŒ åç«¯æ•°æ®åŠ è½½å¤±è´¥:', error);
        // å¦‚æœåç«¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®
        console.log('âš ï¸ ä½¿ç”¨æœ¬åœ°æ•°æ®ä½œä¸ºå¤‡é€‰');
      }
      
      console.log('ğŸ” [History] appData.foodRecords:', appData.foodRecords);
      console.log('ğŸ” [History] è®°å½•æ•°é‡:', appData.foodRecords ? appData.foodRecords.length : 0);
      
      // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
      if (!appData.foodRecords || appData.foodRecords.length === 0) {
        console.log('â„¹ï¸ æ²¡æœ‰å†å²è®°å½•');
        historyContainer.innerHTML = `
          <div class="text-center text-gray-500 py-4">
            æš‚æ— å†å²è®°å½•
          </div>
        `;
        return;
      }
      
      // ç»Ÿè®¡è®°å½•é¢‘ç‡
      const recordFrequency = {};
      appData.foodRecords.forEach(record => {
        if (!recordFrequency[record.description]) {
          recordFrequency[record.description] = {
            count: 0,
            record: record
          };
        }
        recordFrequency[record.description].count++;
      });
      
      // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰é¢‘ç‡æ’åº
      const sortedRecords = Object.values(recordFrequency)
        .sort((a, b) => b.count - a.count)
        .slice(0, 6); // å–å‰6ä¸ªæœ€é¢‘ç¹çš„è®°å½•
      
      // æ¸…ç©ºå®¹å™¨
      historyContainer.innerHTML = '';
      
      // æ·»åŠ è®°å½•é¡¹
      sortedRecords.forEach(item => {
        const record = item.record;
        const historyItem = document.createElement('div');
        historyItem.className = 'history-record-item bg-gray-50 rounded-lg p-3 flex flex-col items-center cursor-pointer hover:bg-gray-100 transition-all-300';
        historyItem.setAttribute('data-id', record.id);
        
        let itemHTML = '';
        
        // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡
        if (record.image) {
          itemHTML += `
            <img src="${record.image}" alt="é£Ÿç‰©å›¾ç‰‡" class="w-full h-16 object-cover rounded-lg mb-2">
          `;
        } else {
          // ä½¿ç”¨é»˜è®¤å›¾æ ‡
          itemHTML += `
            <div class="w-full h-16 bg-gray-200 rounded-lg mb-2 flex items-center justify-center">
              <i class="fa fa-cutlery text-gray-400 text-2xl"></i>
            </div>
          `;
        }
        
        itemHTML += `
          <p class="text-xs text-center truncate w-full">${record.description}</p>
          <p class="text-xs text-gray-500 mt-1">${record.calories} kcal</p>
        `;
        
        historyItem.innerHTML = itemHTML;
        historyContainer.appendChild(historyItem);
      });
    }
    
    // åŠ è½½è®°å½•åˆ°è¡¨å•
    function loadRecordToForm(recordId) {
      console.log('ğŸ”„ åŠ è½½è®°å½•åˆ°è¡¨å•:', recordId);
      
      const record = appData.foodRecords.find(r => r.id === recordId);
      if (!record) {
        console.log('âŒ æ‰¾ä¸åˆ°è®°å½•:', recordId);
        return;
      }
      
      console.log('âœ… æ‰¾åˆ°è®°å½•:', record);
      
      // å¡«å……æè¿°
      const foodDescEl = document.getElementById('food-description');
      if (foodDescEl) {
        foodDescEl.value = record.description || 'æœªå‘½åé£Ÿç‰©';
        console.log('âœ… å·²å¡«å……æè¿°:', record.description);
      }
      
      // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡
      const imageSrc = record.image || record.imageUrl; // å…¼å®¹ä¸¤ç§å­—æ®µ
      if (imageSrc) {
        console.log('ğŸ–¼ï¸ åŠ è½½å›¾ç‰‡æ•°æ®:', imageSrc ? 'æœ‰å›¾ç‰‡' : 'æ— å›¾ç‰‡');
        
        const imagePreview = document.getElementById('image-preview');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const img = imagePreview ? imagePreview.querySelector('img') : null;
        
        if (img && imageSrc) {
          img.src = imageSrc;
          imagePreview.classList.remove('hidden');
          uploadPlaceholder.classList.add('hidden');
          console.log('âœ… å›¾ç‰‡å·²æ˜¾ç¤º');
          
          // åŒæ—¶è®¾ç½®æ–‡ä»¶è¾“å…¥æ¡†ï¼ˆæ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©ï¼‰
          const foodImage = document.getElementById('food-image');
          if (foodImage) {
            // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶å¯¹è±¡
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const tempImg = new Image();
            
            tempImg.onload = function() {
              canvas.width = tempImg.width;
              canvas.height = tempImg.height;
              ctx.drawImage(tempImg, 0, 0);
              
              canvas.toBlob(function(blob) {
                const file = new File([blob], 'loaded-image.jpg', { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                foodImage.files = dataTransfer.files;
                console.log('âœ… æ–‡ä»¶è¾“å…¥æ¡†å·²è®¾ç½®');
              }, 'image/jpeg');
            };
            
            tempImg.src = imageSrc;
          }
        }
      } else {
        console.log('â„¹ï¸ è¯¥è®°å½•æ²¡æœ‰å›¾ç‰‡');
        // éšè—å›¾ç‰‡é¢„è§ˆ
        const imagePreview = document.getElementById('image-preview');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        if (imagePreview && uploadPlaceholder) {
          imagePreview.classList.add('hidden');
          uploadPlaceholder.classList.remove('hidden');
        }
        
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
        const foodImage = document.getElementById('food-image');
        if (foodImage) {
          foodImage.value = '';
        }
      }
      
      // æ»šåŠ¨åˆ°åˆ†ææŒ‰é’®
      const analyzeBtn = document.getElementById('analyze-btn');
      if (analyzeBtn) {
        analyzeBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      console.log('âœ… è®°å½•åŠ è½½å®Œæˆ');
      
      // æ˜¾ç¤ºæç¤º
      alert('å·²åŠ è½½å†å²è®°å½•ï¼Œè¯·ç‚¹å‡»"åˆ†æè¥å…»æˆåˆ†"æŒ‰é’®ç¡®è®¤');
    }

    // é‡ç½®å¡è·¯é‡Œè¡¨å•
    function resetCalorieForm() {
      document.getElementById('food-image').value = '';
      document.getElementById('food-description').value = '';
      document.getElementById('image-preview').classList.add('hidden');
      document.getElementById('upload-placeholder').classList.remove('hidden');
      document.getElementById('image-preview').querySelector('img').src = '';
    }
    
    // æ˜¾ç¤ºå›¾ç‰‡æ¨¡æ€æ¡†
    function showImageModal(imageSrc) {
      console.log('ğŸ–¼ï¸ æ˜¾ç¤ºå›¾ç‰‡æ¨¡æ€æ¡†:', imageSrc.substring(0, 50) + '...');
      
      // åˆ›å»ºæ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
      modal.onclick = function(e) {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      };
      
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-4 max-w-4xl max-h-4xl relative">
          <button class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl" onclick="document.body.removeChild(this.closest('.fixed'))">
            <i class="fa fa-times"></i>
          </button>
          <img src="${imageSrc}" alt="é£Ÿç‰©å›¾ç‰‡" class="max-w-full max-h-96 object-contain rounded">
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // æ˜¾ç¤ºåˆ†æç»“æœ
    function showAnalysisResult(result) {
      // ä¿å­˜å½“å‰è®°å½•
      appData.currentRecord = result;
      
      // æ›´æ–°ç»“æœæ—¶é—´
      const now = new Date();
      const timeString = now.toTimeString().split(' ')[0].substring(0, 5);
      const dateString = now.toISOString().split('T')[0];
      const resultTimeEl = document.getElementById('result-time');
      if (resultTimeEl) {
        resultTimeEl.textContent = `${dateString} ${timeString}`;
      }
      
      // æ›´æ–°è¥å…»æ•°æ®
      const resultCaloriesEl = document.getElementById('result-calories');
      const resultProteinEl = document.getElementById('result-protein');
      const resultMacrosEl = document.getElementById('result-macros');
      const resultAdviceEl = document.getElementById('result-advice');
      
      if (resultCaloriesEl) {
        resultCaloriesEl.innerHTML = `${result.calories}<span class="text-sm font-normal text-gray-500">kcal</span>`;
      }
      if (resultProteinEl) {
        resultProteinEl.innerHTML = `${result.protein}<span class="text-sm font-normal text-gray-500">g</span>`;
      }
      if (resultMacrosEl) {
        resultMacrosEl.innerHTML = `${result.carbs}/${result.fat}<span class="text-sm font-normal text-gray-500">g</span>`;
      }
      if (resultAdviceEl) {
        resultAdviceEl.textContent = result.advice;
      }
      
      // æ˜¾ç¤ºç»“æœ
      document.getElementById('analysis-result').classList.remove('hidden');
      
      // æ»šåŠ¨åˆ°ç»“æœ
      document.getElementById('analysis-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // åˆå§‹åŒ–è®¾ç½®é¡µé¢
    function initSettings() {
      // ä½“é‡ç›®æ ‡æ»‘å—
      const weightGoalInput = document.getElementById('weight-goal-input');
      const weightGoalValue = document.getElementById('weight-goal-value');
      
      weightGoalInput.addEventListener('input', function() {
        weightGoalValue.textContent = parseFloat(this.value).toFixed(1);
      });
      
      // ä¿å­˜ç›®æ ‡æŒ‰é’®ç‚¹å‡»
      const saveGoalBtn = document.getElementById('save-goal');
      saveGoalBtn.addEventListener('click', function() {
        const goal = parseFloat(weightGoalInput.value) * 1000; // è½¬æ¢ä¸ºå…‹
        appData.userProfile.weightGoal = goal;
        
        // æ›´æ–°UI
        updateUI();
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        alert('ç›®æ ‡å·²ä¿å­˜');
      });
      

      
      // ç«‹å³åŒæ­¥æŒ‰é’®ç‚¹å‡»
      const syncGarminBtn = document.getElementById('sync-garmin');
      syncGarminBtn.addEventListener('click', function() {
        // æ˜¾ç¤ºåŠ è½½å¼¹çª—
        showLoadingModal('æ­£åœ¨åŒæ­¥Garminæ•°æ®...');
        
        // æ¨¡æ‹ŸåŒæ­¥å»¶è¿Ÿ
        setTimeout(function() {
          // æ¨¡æ‹ŸåŒæ­¥ç»“æœ
          const garminData = simulateGarminData();
          
          // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
          appData.userProfile.lastSync = new Date().toISOString();
          
          // æ›´æ–°æ¯æ—¥æ±‡æ€»
          updateDailySummary(garminData);
          
          // æ›´æ–°UI
          updateUI();
          
          // éšè—åŠ è½½å¼¹çª—
          hideLoadingModal();
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          alert('åŒæ­¥æˆåŠŸ');
        }, 2000);
      });
      

    }

    // æ›´æ–°è®¾ç½®é¡µé¢
    function updateSettings() {
      // æ›´æ–°ä½“é‡ç›®æ ‡
      const weightGoal = appData.userProfile.weightGoal / 1000; // è½¬æ¢ä¸ºåƒå…‹
      document.getElementById('weight-goal-input').value = weightGoal;
      document.getElementById('weight-goal-value').textContent = weightGoal.toFixed(1);
      
      // æ›´æ–°GarminçŠ¶æ€
      const garminStatus = document.getElementById('garmin-status');
      
      garminStatus.textContent = appData.userProfile.garminConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
      garminStatus.className = appData.userProfile.garminConnected ? 'text-sm text-green-600' : 'text-sm text-red-600';
      
      // æ›´æ–°æœ€ååŒæ­¥æ—¶é—´
      if (appData.userProfile.lastSync) {
        const date = new Date(appData.userProfile.lastSync);
        const dateString = date.toISOString().split('T')[0];
        const timeString = date.toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('last-sync-time').textContent = `${dateString} ${timeString}`;
      } else {
        document.getElementById('last-sync-time').textContent = 'ä»æœªåŒæ­¥';
      }
    }

    // åˆå§‹åŒ–æ¨¡æ€æ¡†
    function initModals() {
      // è¿™é‡Œå¯ä»¥æ·»åŠ åˆå§‹åŒ–æ¨¡æ€æ¡†çš„é€»è¾‘
    }
    

    
    // ä¸ºåº•éƒ¨å¯¼èˆªæ æ·»åŠ ç‚¹å‡»äº‹ä»¶å§”æ‰˜ - å¢å¼ºç‰ˆ
    document.querySelector('nav').addEventListener('click', function(e) {
      console.log('å¯¼èˆªæ è¢«ç‚¹å‡»:', e.target);
      const tab = e.target.closest('.nav-tab');
      if (tab) {
        console.log('å¯¼èˆªæŒ‰é’®è¢«ç‚¹å‡»:', tab.getAttribute('data-tab'));
        // ç›´æ¥è°ƒç”¨åˆ‡æ¢å‡½æ•°
        switchTab(tab.getAttribute('data-tab'));
        // é˜»æ­¢äº‹ä»¶å†’æ³¡
        e.stopPropagation();
      }
    });
    
    // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–å…ƒç´ é˜»æ­¢äº†äº‹ä»¶
    // æ³¨é‡Šæ‰å…¨å±€ç›‘å¬å™¨ï¼Œé¿å…å¹²æ‰°å…¶ä»–ç‚¹å‡»äº‹ä»¶
    // document.addEventListener('click', function(e) {
    //   console.log('å…¨å±€ç‚¹å‡»:', e.target);
    // }, true);

    // æ˜¾ç¤ºåŠ è½½å¼¹çª—
    function showLoadingModal(text) {
      const loadingModal = document.getElementById('loading-modal');
      const loadingText = document.getElementById('loading-text');
      
      if (!loadingModal || !loadingText) {
        console.warn('[Loading] åŠ è½½å¼¹çª—å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      if (text) {
        loadingText.textContent = text;
      }
      
      loadingModal.classList.remove('hidden');
    }

    // éšè—åŠ è½½å¼¹çª—
    function hideLoadingModal() {
      const loadingModal = document.getElementById('loading-modal');
      if (!loadingModal) {
        console.warn('[Loading] åŠ è½½å¼¹çª—å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      loadingModal.classList.add('hidden');
    }

    // æ›´æ–°æ¯æ—¥æ±‡æ€»
    function updateDailySummary(garminData) {
      const today = new Date().toISOString().split('T')[0];
      const todayRecords = appData.foodRecords.filter(record => record.date === today);
      
      // è®¡ç®—æ€»æ‘„å…¥
      let totalCaloriesIn = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      
      todayRecords.forEach(record => {
        totalCaloriesIn += record.calories;
        totalProtein += record.protein;
        totalCarbs += record.carbs;
        totalFat += record.fat;
      });
      
      // è·å–æ¶ˆè€—æ•°æ®
      let totalCaloriesOut = 2000; // é»˜è®¤åŸºç¡€ä»£è°¢
      let trainingType = 'none';
      
      if (garminData) {
        totalCaloriesOut = garminData.totalCalories;
        trainingType = garminData.trainingType;
      } else {
        // æ£€æŸ¥æ˜¯å¦æœ‰Garminæ•°æ®
        const garminData = simulateGarminData(); // æ¨¡æ‹Ÿæ•°æ®
        totalCaloriesOut = garminData.totalCalories;
        trainingType = garminData.trainingType;
      }
      
      // è®¡ç®—è„‚è‚ªå˜åŒ–
      const fatChangeResult = estimate_fat_change(totalCaloriesIn, totalCaloriesOut, trainingType);
      
      // æ›´æ–°æ¯æ—¥æ±‡æ€»
      const summaryIndex = appData.dailySummaries.findIndex(s => s.date === today);
      
      if (summaryIndex !== -1) {
        // æ›´æ–°ç°æœ‰æ±‡æ€»
        appData.dailySummaries[summaryIndex] = {
          date: today,
          totalCaloriesIn,
          totalProtein,
          totalCarbs,
          totalFat,
          totalCaloriesOut,
          trainingType,
          fatChange: fatChangeResult.fat_change_g
        };
      } else {
        // æ·»åŠ æ–°æ±‡æ€»
        appData.dailySummaries.push({
          date: today,
          totalCaloriesIn,
          totalProtein,
          totalCarbs,
          totalFat,
          totalCaloriesOut,
          trainingType,
          fatChange: fatChangeResult.fat_change_g
        });
      }
      
      // æ›´æ–°å½“å‰å‡è„‚é‡
      if (summaryIndex !== -1) {
        const previousFatChange = appData.dailySummaries[summaryIndex].fatChange;
        appData.userProfile.currentWeightLoss = Math.max(0, appData.userProfile.currentWeightLoss - previousFatChange + fatChangeResult.fat_change_g);
      } else {
        appData.userProfile.currentWeightLoss += Math.abs(fatChangeResult.fat_change_g);
      }
    }

    // æ¨¡æ‹ŸAIåˆ†æ
    function simulateAIAnalysis(imageUrl, description) {
      // è¿™é‡Œä½¿ç”¨é¢„è®¾çš„é£Ÿç‰©æ•°æ®åº“æ¨¡æ‹ŸAIåˆ†æ
      const foodDatabase = [
        { keywords: ["ç‚¸é¸¡", "é¸¡æ’"], calories: 300, protein: 25, carbs: 10, fat: 18 },
        { keywords: ["ç±³é¥­", "ç™½é¥­"], calories: 150, protein: 3, carbs: 35, fat: 0.5 },
        { keywords: ["è”¬èœ", "é’èœ"], calories: 50, protein: 3, carbs: 10, fat: 0.5 },
        { keywords: ["ç‰›è‚‰", "ç‰›æ’"], calories: 250, protein: 25, carbs: 0, fat: 18 },
        { keywords: ["æ²™æ‹‰", "è”¬èœæ²™æ‹‰"], calories: 100, protein: 5, carbs: 15, fat: 3 },
        { keywords: ["é¢åŒ…", "åå¸"], calories: 120, protein: 4, carbs: 25, fat: 1.5 },
        { keywords: ["é¸¡è›‹", "è›‹"], calories: 70, protein: 6, carbs: 0, fat: 5 },
        { keywords: ["ç‰›å¥¶"], calories: 100, protein: 8, carbs: 12, fat: 3 },
        { keywords: ["é¸¡èƒ¸è‚‰"], calories: 165, protein: 31, carbs: 0, fat: 3.6 },
        { keywords: ["æ°´æœ", "æ°´æœæ²™æ‹‰"], calories: 80, protein: 1, carbs: 20, fat: 0 },
        { keywords: ["å¥èº«é¤"], calories: 450, protein: 40, carbs: 30, fat: 15 }
      ];
      
      let calories = 0;
      let protein = 0;
      let carbs = 0;
      let fat = 0;
      
      // ç®€å•çš„å…³é”®è¯åŒ¹é…
      if (description) {
        foodDatabase.forEach(food => {
          food.keywords.forEach(keyword => {
            if (description.includes(keyword)) {
              calories += food.calories;
              protein += food.protein;
              carbs += food.carbs;
              fat += food.fat;
            }
          });
        });
      }
      
      // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°é£Ÿç‰©ï¼Œè¯´æ˜AIåˆ†æå¤±è´¥
      if (calories === 0) {
        console.error('âŒ AIåˆ†æå¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆç»“æœ');
        console.error('âŒ è¯·æ£€æŸ¥AI APIæ˜¯å¦æ­£ç¡®è°ƒç”¨');
        throw new Error('AIåˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®');
      }
      
      // ç”ŸæˆAIå»ºè®®
      const adviceOptions = [
        "ä»Šå¤©çš„é¥®é£Ÿæ­é…ä¸é”™ï¼Œç»§ç»­ä¿æŒï¼",
        "ä¸‹åˆå¯ä»¥å¢åŠ ä¸€äº›æœ‰æ°§è¿åŠ¨ï¼Œå¸®åŠ©æ¶ˆè€—å¤šä½™çƒ­é‡ã€‚",
        "å»ºè®®å¢åŠ è›‹ç™½è´¨æ‘„å…¥ï¼Œæœ‰åŠ©äºè‚Œè‚‰ç»´æŒã€‚",
        "æ³¨æ„æ§åˆ¶ç¢³æ°´åŒ–åˆç‰©çš„æ‘„å…¥ï¼Œé€‰æ‹©æ›´å¥åº·çš„ç¢³æ°´æ¥æºã€‚",
        "å¤šå–æ°´ï¼Œä¿æŒèº«ä½“æ°´åˆ†å……è¶³ã€‚",
        "æ™šé¤å¯ä»¥é€‚å½“å‡å°‘ä»½é‡ï¼Œæœ‰åŠ©äºå¤œé—´æ¶ˆåŒ–ã€‚"
      ];
      
      const advice = adviceOptions[Math.floor(Math.random() * adviceOptions.length)];
      
      return {
        calories,
        protein,
        carbs,
        fat,
        advice
      };
    }

    // æ¨¡æ‹ŸGarminæ•°æ®
    function simulateGarminData() {
      // æ¨¡æ‹ŸGarminæ•°æ®
      const trainingTypes = ["none", "A", "S", "both"];
      const randomType = trainingTypes[Math.floor(Math.random() * trainingTypes.length)];
      
      // åŸºç¡€ä»£è°¢ç‡ + æ´»åŠ¨æ¶ˆè€—
      const baseMetabolism = 1800; // åŸºç¡€ä»£è°¢ç‡
      const activityLevel = Math.random(); // 0-1ä¹‹é—´çš„æ´»åŠ¨æ°´å¹³
      
      let activityCalories = 0;
      if (randomType === "A") {
        activityCalories = 300 + Math.random() * 200; // æœ‰æ°§æ¶ˆè€—300-500
      } else if (randomType === "S") {
        activityCalories = 200 + Math.random() * 150; // æ— æ°§æ¶ˆè€—200-350
      } else if (randomType === "both") {
        activityCalories = 400 + Math.random() * 300; // æ··åˆæ¶ˆè€—400-700
      } else {
        activityCalories = 50 + Math.random() * 150; // æ—¥å¸¸æ´»åŠ¨æ¶ˆè€—50-200
      }
      
      const totalCalories = baseMetabolism + activityCalories;
      
      return {
        connected: true,
        lastSync: new Date().toISOString(),
        totalCalories,
        trainingType: randomType,
        steps: Math.floor(5000 + Math.random() * 10000), // 5000-15000æ­¥
        heartRate: {
          average: 65 + Math.floor(Math.random() * 20),
          max: 120 + Math.floor(Math.random() * 50)
        }
      };
    }

    // è„‚è‚ªå˜åŒ–ä¼°ç®—ç®—æ³•
    function estimate_fat_change(cal_in, cal_out, training_type) {
      const D = cal_in - cal_out; // çƒ­é‡å·®ï¼Œæ­£å€¼=ç›ˆä½™ï¼Œè´Ÿå€¼=èµ¤å­—

      // === æƒ…å†µ1ï¼šèµ¤å­—ï¼ˆå‡è„‚ï¼‰ ===
      if (D < 0) {
        const D_abs = Math.abs(D);
        // èµ¤å­—åŒºé—´åŸºç¡€ç³»æ•°
        let f_base;
        if (D_abs <= 700) {
          f_base = 0.60;
        } else if (D_abs <= 900) {
          f_base = 0.55;
        } else {
          f_base = 0.45;
        }

        // è®­ç»ƒä¿®æ­£ï¼ˆèµ¤å­—æ—¶ï¼‰
        const t_adj = {"none": 0.00, "A": 0.08, "S": 0.10, "both": 0.18};
        const f_ratio = f_base + (t_adj[training_type] || 0.00);

        const fat_change = -D_abs * f_ratio / 9; // kcal è½¬ gè„‚è‚ªï¼Œ1gè„‚è‚ªçº¦9 kcal

        return {
          "D": D_abs,
          "mode": "deficit",
          "ratio": f_ratio,
          "fat_change_g": fat_change
        };
      }

      // === æƒ…å†µ2ï¼šç›ˆä½™ï¼ˆå¢è„‚ï¼‰ ===
      else {
        if (D <= 400) {
          s_base = 0.50;
        } else if (D <= 800) {
          s_base = 0.65;
        } else {
          s_base = 0.80;
        }

        // è®­ç»ƒä¿®æ­£ï¼ˆç›ˆä½™æ—¶ï¼‰
        const t_adj = {"none": 0.00, "A": -0.05, "S": -0.15, "both": -0.20};
        const s_ratio = s_base + (t_adj[training_type] || 0.00);

        const fat_change = D * s_ratio / 9;

        return {
          "D": D,
          "mode": "surplus",
          "ratio": s_ratio,
          "fat_change_g": fat_change
        };
      }
    }
  </script>


</body></html>